<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>レポートアプリ</title> <script src="https://cdn.tailwindcss.com"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Noto Sans JP', sans-serif;
      background-color: #f8f7f7;
    }
    .btn {
      @apply py-2 px-6 border border-gray-800 text-gray-800 transition-all duration-300 rounded-md text-sm font-bold tracking-wider shadow-sm whitespace-nowrap;
    }
    .btn:hover:not(:disabled) {
      @apply bg-gray-800 text-white shadow-md transform -translate-y-px;
    }
    .btn:disabled {
      @apply border-gray-300 text-gray-400 cursor-not-allowed bg-gray-100 shadow-none;
    }
    .btn-active {
      @apply bg-gray-800 text-white shadow-md transform -translate-y-px;
    }
    .select-box {
        @apply block w-full p-3 bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-800 focus:border-transparent transition-shadow;
    }
    .screen {
      @apply w-full max-w-7xl mx-auto p-4 md:p-8;
    }
    .card {
        @apply bg-white p-6 md:p-8 shadow-lg rounded-xl border border-gray-200;
    }
    /* ローディングスピナー */
    #loading-overlay > div {
       border-top-color: #333;
       border-bottom-color: #333;
    }
  </style>
</head>
<body class="text-gray-900">

  <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-gray-800"></div>
    <p id="loading-message" class="absolute mt-24 text-sm text-gray-600"></p>
  </div>

  <div id="screen1" class="screen">
    <div class="card max-w-lg mx-auto mt-12">
      <div class="text-center mb-8">
        <h1 class="text-2xl font-bold text-gray-800">集計期間の選択</h1>
        <p class="text-sm text-gray-500 mt-2">レポートを生成する期間を設定してください。</p>
      </div>
      <div class="space-y-6">
        <div>
            <label for="start-year" class="font-bold text-gray-700 mb-2 block text-sm">開始年月</label>
            <div class="grid grid-cols-2 gap-4">
                <select id="start-year" class="select-box"></select>
                <select id="start-month" class="select-box"></select>
            </div>
        </div>
        <div>
            <label for="end-year" class="font-bold text-gray-700 mb-2 block text-sm">終了年月</label>
            <div class="grid grid-cols-2 gap-4">
                <select id="end-year" class="select-box"></select>
                <select id="end-month" class="select-box"></select>
            </div>
        </div>
        <div class="pt-4 border-t mt-6">
          <button id="next-to-clinics" class="btn w-full bg-gray-800 text-white hover:bg-gray-700">次へ進む</button>
        </div>
      </div>
    </div>
  </div>

  <div id="screen2" class="screen hidden">
    <header class="flex justify-between items-center mb-6 pb-4 border-b">
        <button id="back-to-period" class="btn">&lt; 期間選択へ戻る</button>
        <div id="period-display" class="text-base font-semibold text-gray-700 bg-white py-2 px-4 rounded-lg shadow-sm border"></div>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:px-8">
        <section class="card">
            <h2 class="text-xl font-bold mb-5">1. クリニックを選択</h2>
            <div id="clinic-list-container" class="space-y-3 max-h-96 overflow-y-auto pr-2 border rounded-lg p-4 bg-gray-50">
                <p class="text-sm text-gray-500 text-center py-4">読み込み中...</p>
            </div>
            <div class="mt-6 text-right">
                <button id="issue-btn" class="btn bg-gray-800 text-white hover:bg-gray-700" disabled>レポート発行</button>
            </div>
        </section>
        <section class="card">
            <h2 class="text-xl font-bold mb-5">2. 発行済みレポートを閲覧</h2>
            <div id="issued-list-container" class="space-y-3">
                <p class="text-sm text-gray-500 text-center py-8">まだ発行されたレポートはありません。</p>
            </div>
        </section>
    </main>
  </div>

  <div id="screen3" class="screen hidden">
      <header class="mb-6 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0 pb-6 border-b border-gray-200">
        <div id="report-nav" class="flex flex-wrap justify-center items-center gap-2">
            <button data-report-type="nps" class="btn">NPS推奨度 理由</button>
            <button data-report-type="feedback_i" class="btn">良かった点・悪かった点</button>
            <button data-report-type="feedback_j" class="btn">印象に残ったスタッフ</button>
            <button data-report-type="feedback_m" class="btn">お産にかかわるご意見</button>
            <button data-report-type="satisfaction_b" class="btn">満足度</button>
            <button data-report-type="satisfaction_c" class="btn">施設</button>
            <button data-report-type="satisfaction_d" class="btn">アクセス</button>
            <button data-report-type="satisfaction_e" class="btn">価格</button>
            <button data-report-type="satisfaction_f" class="btn">雰囲気</button>
            <button data-report-type="satisfaction_g" class="btn">スタッフ対応</button>
            <button data-report-type="satisfaction_h" class="btn">先生の説明</button>
            <button data-report-type="age" class="btn">年代</button>
            <button data-report-type="children" class="btn">お子様の数</button>
            <button data-report-type="income" class="btn">世帯年収</button>
        </div>
        <div class="flex items-center gap-4">
            <button id="pdf-export-btn" class="btn bg-gray-800 text-white hover:bg-gray-700">PDF出力</button>
            <button id="back-to-clinics" class="btn">院一覧へ戻る</button>
        </div>
      </header>
      <main class="card">
        <div class="text-center mb-8 pb-4 border-b">
            <h1 id="report-title" class="text-2xl font-bold"></h1>
            <p id="report-subtitle" class="text-sm text-gray-600 mt-2" style="white-space: pre-wrap;"></p>
        </div>

        <div id="slider-container" class="relative">
          <div id="slide-content" class="bg-gray-50 border p-6 md:p-8 rounded-lg min-h-[500px]">
            <h2 id="slide-header" class="text-xl font-bold mb-5 text-gray-800"></h2>
            <div id="slide-body" class="text-base leading-relaxed text-gray-700" style="white-space: pre-wrap;"></div>
          </div>
          <div id="pagination" class="flex items-center justify-center mt-6">
            <button id="prev-slide" class="btn">&lt; 前へ</button>
            <span id="page-indicator" class="mx-6 text-base font-semibold text-gray-600"></span>
            <button id="next-slide" class="btn">次へ &gt;</button>
          </div>
        </div>
      </main>
  </div>

  <div id="report-type-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-40 hidden">
    <div class="bg-white p-8 shadow-xl w-full max-w-md rounded-xl transform transition-all duration-300 scale-95 opacity-0">
      <h2 class="text-xl font-bold mb-6 text-center">表示するレポートを選択</h2>
      <div class="flex flex-wrap justify-center gap-3">
        <button data-report-type="nps" class="btn">NPS推奨度 理由</button>
        <button data-report-type="feedback_i" class="btn">良かった点・悪かった点</button>
        <button data-report-type="feedback_j" class="btn">印象に残ったスタッフ</button>
        <button data-report-type="feedback_m" class="btn">お産にかかわるご意見</button>
        <button data-report-type="satisfaction_b" class="btn">満足度</button>
        <button data-report-type="satisfaction_c" class="btn">施設</button>
        <button data-report-type="satisfaction_d" class="btn">アクセス</button>
        <button data-report-type="satisfaction_e" class="btn">価格</button>
        <button data-report-type="satisfaction_f" class="btn">雰囲気</button>
        <button data-report-type="satisfaction_g" class="btn">スタッフ対応</button>
        <button data-report-type="satisfaction_h" class="btn">先生の説明</button>
        <button data-report-type="age" class="btn">年代</button>
        <button data-report-type="children" class="btn">お子様の数</button>
        <button data-report-type="income" class="btn">世帯年収</button>
      </div>
      <div class="mt-8 text-center">
        <button id="cancel-report-selection" class="text-sm text-gray-600 hover:underline">キャンセル</button>
      </div>
    </div>
  </div>

<script>
  let selectedPeriod = {};
  let issuedReports = {}; // レポートデータを保持
  let currentClinicForModal = ''; // モーダル表示対象のクリニック名
  let slidesData = []; // コメント系レポートのスライドデータ
  let currentPage = 1; // コメント系レポートの現在ページ

  // Google Charts のロード完了を待つための Promise
  const googleChartsLoaded = new Promise(resolve => {
    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(resolve);
  });

  document.addEventListener('DOMContentLoaded', async () => {
    console.log('DOM Content Loaded. Initializing...'); // ログ追加
    populateDateSelectors();
    
    // Google Charts のロードを待つ
    try {
        await googleChartsLoaded;
        console.log('Google Charts loaded successfully.'); // ログ追加
    } catch (err) {
        console.error('Failed to load Google Charts:', err); // エラーログ
        alert('グラフライブラリの読み込みに失敗しました。ページを再読み込みしてください。');
        return; // チャートがなければ続行不可
    }

    // イベントリスナー設定
    setupEventListeners();
    console.log('Event listeners set up.'); // ログ追加
  });

  function setupEventListeners() {
    document.getElementById('next-to-clinics').addEventListener('click', handleNextToClinics);
    document.getElementById('issue-btn').addEventListener('click', handleIssueReport);
    document.getElementById('issued-list-container').addEventListener('click', handleIssuedListClick);
    document.getElementById('report-type-modal').addEventListener('click', handleReportModalClick);
    document.getElementById('report-nav').addEventListener('click', handleReportNavClick);
    document.getElementById('cancel-report-selection').addEventListener('click', () => showReportModal(false));
    document.getElementById('prev-slide').addEventListener('click', handlePrevSlide);
    document.getElementById('next-slide').addEventListener('click', handleNextSlide);
    document.getElementById('back-to-clinics').addEventListener('click', () => showScreen('screen2'));
    document.getElementById('back-to-period').addEventListener('click', () => showScreen('screen1'));
    document.getElementById('pdf-export-btn').addEventListener('click', generatePdf); // PDFボタンはまだダミー
  }

  // --- 画面1: 期間選択 ---
  function populateDateSelectors() {
    // 省略 (変更なし)
    const now = new Date();
    const currentYear = now.getFullYear();
    const startYearSelect = document.getElementById('start-year');
    const endYearSelect = document.getElementById('end-year');
    for (let i = 0; i < 5; i++) { const year = currentYear - i; startYearSelect.add(new Option(`${year}年`, year)); endYearSelect.add(new Option(`${year}年`, year)); }
    const startMonthSelect = document.getElementById('start-month');
    const endMonthSelect = document.getElementById('end-month');
    for (let i = 1; i <= 12; i++) { const month = String(i).padStart(2, '0'); startMonthSelect.add(new Option(`${i}月`, month)); endMonthSelect.add(new Option(`${i}月`, month)); }
    endMonthSelect.value = String(now.getMonth() + 1).padStart(2, '0');
    startMonthSelect.value = String(now.getMonth() + 1).padStart(2, '0');
  }

  function handleNextToClinics() {
    console.log('Next to clinics button clicked.'); // ログ追加
    const startYear = document.getElementById('start-year').value;
    const startMonth = document.getElementById('start-month').value;
    const endYear = document.getElementById('end-year').value;
    const endMonth = document.getElementById('end-month').value;
    
    const startDate = new Date(`${startYear}-${startMonth}-01`);
    const endDate = new Date(`${endYear}-${endMonth}-01`);

    if (startDate > endDate) {
        console.warn('Start date is after end date.'); // 警告ログ
        alert('開始年月は終了年月より前に設定してください。'); // UIフィードバック
        document.getElementById('start-year').classList.add('border-red-500');
        document.getElementById('start-month').classList.add('border-red-500');
        return;
    }
    
    document.getElementById('start-year').classList.remove('border-red-500');
    document.getElementById('start-month').classList.remove('border-red-500');
    
    selectedPeriod = { start: `${startYear}-${startMonth}`, end: `${endYear}-${endMonth}` };
    document.getElementById('period-display').textContent = `集計期間：${startYear}年${startMonth}月～${endYear}年${endMonth}月`;
    console.log('Selected period:', selectedPeriod); // ログ追加
    
    showScreen('screen2');
    // issuedReportsが空の場合のみクリニック一覧を読み込む
    if (Object.keys(issuedReports).length === 0) {
        console.log('No issued reports found, loading clinics...'); // ログ追加
        loadClinics();
    } else {
        console.log('Issued reports exist, not reloading clinics.'); // ログ追加
    }
  }

  // --- 画面2: クリニック選択 & レポート発行 ---
  async function loadClinics() {
    console.log('Executing loadClinics function...'); // ログ追加
    showLoading(true, 'クリニック一覧を読み込み中...');
    const container = document.getElementById('clinic-list-container');
    container.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">読み込み中...</p>'; // ローディング表示改善
    
    try {
      console.log('Fetching /api/getClinicList...'); // ログ追加
      const response = await fetch('/api/getClinicList');
      console.log('Fetch response status:', response.status); // ログ追加

      if (!response.ok) {
        const errorText = await response.text();
        console.error('Server responded with error:', response.status, errorText); // エラーログ詳細化
        throw new Error(`サーバーエラー (${response.status}): ${errorText}`);
      }
      
      const clinics = await response.json();
      console.log('Received clinics:', clinics); // ログ追加

      container.innerHTML = ''; // コンテナをクリア
      if (!Array.isArray(clinics)) {
          console.error('Received data is not an array:', clinics);
          throw new Error('サーバーから予期しない形式のデータを受信しました。');
      }

      if (clinics.length === 0) {
          console.log('No clinics found.'); // ログ追加
          container.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">対象クリニックが見つかりませんでした。</p>';
      } else {
          clinics.forEach(name => {
            const div = document.createElement('div');
            div.className = 'flex items-center p-2 rounded-md hover:bg-gray-100';
            div.innerHTML = `
                <input type="checkbox" id="clinic-${name}" name="clinic" value="${name}" class="mr-3 h-4 w-4 rounded border-gray-300 text-gray-800 focus:ring-gray-800 cursor-pointer">
                <label for="clinic-${name}" class="text-sm select-none cursor-pointer">${name}</label>
            `;
            container.appendChild(div);
          });
          console.log('Clinic list populated.'); // ログ追加
          
          // チェックボックス変更時のイベントリスナーを設定
          container.removeEventListener('change', handleClinicCheckboxChange); // 古いリスナーを削除
          container.addEventListener('change', handleClinicCheckboxChange);
      }
      showLoading(false);

    } catch (err) {
      console.error('!!! Failed to load clinics:', err); // エラーログ強調
      container.innerHTML = `<p class="text-sm text-red-500 text-center py-4">クリニック一覧の読み込みに失敗しました。<br>${err.message}</p>`;
      showLoading(false);
    }
  }
  
  // チェックボックス変更時のハンドラ関数
  function handleClinicCheckboxChange() {
      const checked = document.querySelectorAll('#clinic-list-container input[type="checkbox"]:checked').length;
      document.getElementById('issue-btn').disabled = checked === 0;
  }

  // レポート発行ボタンの処理（まだサーバー側は未実装）
  async function handleIssueReport() {
    console.log('Issue report button clicked.'); // ログ追加
    showLoading(true, 'レポートデータを取得中...');
    const selectedClinics = Array.from(document.querySelectorAll('#clinic-list-container input:checked')).map(cb => cb.value);
    console.log('Selected clinics for report:', selectedClinics); // ログ追加
    
    try {
      console.log('Posting to /api/getReportData...'); // ログ追加
      const response = await fetch('/api/getReportData', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          period: selectedPeriod,
          selectedClinics: selectedClinics
        })
      });
      console.log('Fetch response status:', response.status); // ログ追加

      if (!response.ok) {
        const errorText = await response.text();
        console.error('Server responded with error:', response.status, errorText); // エラーログ詳細化
        throw new Error(`サーバーエラー (${response.status}): ${errorText}`);
      }
      
      const data = await response.json();
      console.log('Received report data:', data); // ログ追加

      // --- レポートデータ処理 (※サーバーが {} を返す間はここは通らない) ---
      const timestamp = new Date().toLocaleString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
      let reportGenerated = false;
      Object.keys(data).forEach(clinicName => {
          if (selectedClinics.includes(clinicName)) { // 選択されたクリニックのみを対象
              issuedReports[clinicName] = { ...data[clinicName], timestamp };
              reportGenerated = true;
              console.log(`Report data stored for ${clinicName}`); // ログ追加
          }
      });
      
      if (reportGenerated) {
        updateIssuedList(); // 発行済みリストを更新
        currentClinicForModal = selectedClinics[0]; // 最初のクリニックをモーダル用に設定
        if (currentClinicForModal && issuedReports[currentClinicForModal]) {
            console.log(`Showing report type modal for ${currentClinicForModal}`); // ログ追加
            showReportModal(true);
        } else {
             console.warn('Report generated but no data found for the first selected clinic:', currentClinicForModal);
        }
      } else {
          console.warn('Report data received, but it was empty or did not contain selected clinics.'); // 警告ログ
          alert('レポートデータの取得に失敗したか、対象データがありませんでした。');
      }
      // --- ここまで ---
      
      showLoading(false);

    } catch (err) {
      console.error('!!! Failed to issue report:', err); // エラーログ強調
      alert(`レポートの発行に失敗しました。\n${err.message}`); // UIフィードバック
      showLoading(false);
    }
  }
  
  // 発行済みリストの更新 (変更なし)
  function updateIssuedList() {
    const container = document.getElementById('issued-list-container');
    container.innerHTML = '';
    const clinicNames = Object.keys(issuedReports);
    if (clinicNames.length === 0) { container.innerHTML = '<p class="text-sm text-gray-500 text-center py-8">まだ発行されたレポートはありません。</p>'; return; }
    clinicNames.forEach(name => { const div = document.createElement('div'); div.className = 'p-4 border rounded-lg cursor-pointer hover:bg-gray-50 hover:shadow-md transition-all duration-200'; div.dataset.clinicName = name; div.innerHTML = `<p class="font-bold text-base">${name}</p><p class="text-xs text-gray-500 mt-1">発行日時: ${issuedReports[name].timestamp}</p>`; container.appendChild(div); });
    console.log('Issued list updated.'); // ログ追加
  }

  // --- 画面3: レポート表示 ---
  // (prepareAndShowReport, prepareNpsSlides, prepareCommentSlides, prepareChartShell, renderSlide, drawSatisfactionCharts, drawIncomeCharts は変更なし)
  // 省略... (元のコードと同じ)
  function prepareAndShowReport(reportType){ /* ... */ }
  function prepareNpsSlides(results, title){ /* ... */ }
  function prepareCommentSlides(data, title){ /* ... */ }
  function prepareChartShell(title, subtitle, isBarChart = false){ /* ... */ }
  function renderSlide(page){ /* ... */ }
  function drawSatisfactionCharts(clinicChartData){ /* ... */ }
  function drawIncomeCharts({ results, totalCount }){ /* ... */ }

  // --- イベントハンドラ ---
  // 省略 (変更なし)
  function handleIssuedListClick(e){ /* ... */ }
  function handleReportModalClick(e){ /* ... */ }
  function handleReportNavClick(e){ /* ... */ }
  function handlePrevSlide(){ /* ... */ }
  function handleNextSlide(){ /* ... */ }

  // --- 汎用関数 ---
  // 省略 (変更なし)
  function showScreen(screenId){ /* ... */ }
  function showLoading(isLoading, message = ''){ /* ... */ }
  function showReportModal(show){ /* ... */ }
  function updateNavActiveState(activeType){ /* ... */ }
  
  // PDF生成 (ダミー)
  async function generatePdf() {
      console.log('PDF export button clicked (dummy function).'); // ログ追加
      alert('PDF生成機能は現在、Node.jsサーバー側へ移植中です。');
  }
</script>
</body>
</html>
