<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>レポートアプリ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Noto Sans JP', sans-serif;
      background-color: #f8f7f7;
    }
    .btn {
      @apply py-2 px-6 border border-gray-800 text-gray-800 transition-all duration-300 rounded-md text-sm font-bold tracking-wider shadow-sm whitespace-nowrap;
    }
    .btn:hover:not(:disabled) {
      @apply bg-gray-800 text-white shadow-md transform -translate-y-px;
    }
    .btn:disabled {
      @apply border-gray-300 text-gray-400 cursor-not-allowed bg-gray-100 shadow-none;
    }
    .btn-active {
      @apply bg-gray-800 text-white shadow-md transform -translate-y-px;
    }
    .select-box {
        @apply block w-full p-3 bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-800 focus:border-transparent transition-shadow;
    }
    .screen {
      @apply w-full max-w-7xl mx-auto p-4 md:p-8;
    }
    .card {
        @apply bg-white p-6 md:p-8 shadow-lg rounded-xl border border-gray-200;
    }
    /* ローディングスピナー */
    #loading-overlay > div {
       border-top-color: #333;
       border-bottom-color: #333;
    }
  </style>
</head>
<body class="text-gray-900">

  <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="flex flex-col items-center">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-gray-800"></div>
        <p id="loading-message" class="mt-4 text-lg font-semibold text-gray-800"></p>
    </div>
  </div>

  <div id="screen1" class="screen">
    <div class="card max-w-lg mx-auto mt-12">
      <div class="text-center mb-8">
        <h1 class="text-2xl font-bold text-gray-800">集計期間の選択</h1>
        <p class="text-sm text-gray-500 mt-2">レポートを生成する期間を設定してください。</p>
      </div>
      <div class="space-y-6">
        <div>
            <label for="start-year" class="font-bold text-gray-700 mb-2 block text-sm">開始年月</label>
            <div class="grid grid-cols-2 gap-4">
                <select id="start-year" class="select-box"></select>
                <select id="start-month" class="select-box"></select>
            </div>
        </div>
        <div>
            <label for="end-year" class="font-bold text-gray-700 mb-2 block text-sm">終了年月</label>
            <div class="grid grid-cols-2 gap-4">
                <select id="end-year" class="select-box"></select>
                <select id="end-month" class="select-box"></select>
            </div>
        </div>
        <div class="pt-4 border-t mt-6">
          <button id="next-to-clinics" class="btn w-full bg-gray-800 text-white hover:bg-gray-700">次へ進む</button>
        </div>
      </div>
    </div>
  </div>

  <div id="screen2" class="screen hidden">
    <header class="flex justify-between items-center mb-6 pb-4 border-b">
        <button id="back-to-period" class="btn">&lt; 期間選択へ戻る</button>
        <div id="period-display" class="text-base font-semibold text-gray-700 bg-white py-2 px-4 rounded-lg shadow-sm border"></div>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:px-8">
        <section class="card">
            <h2 class="text-xl font-bold mb-5">1. クリニックを選択</h2>
            <div id="clinic-list-container" class="space-y-3 max-h-96 overflow-y-auto pr-2 border rounded-lg p-4 bg-gray-50">
                <p class="text-sm text-gray-500 text-center py-4">読み込み中...</p>
            </div>
            <div class="mt-6 text-right">
                <button id="issue-btn" class="btn bg-gray-800 text-white hover:bg-gray-700" disabled>レポート発行</button>
            </div>
        </section>
        <section class="card">
            <h2 class="text-xl font-bold mb-5">2. 発行済みレポートを閲覧</h2>
            <div id="issued-list-container" class="space-y-3">
                <p class="text-sm text-gray-500 text-center py-8">まだ発行されたレポートはありません。</p>
            </div>
        </section>
    </main>
  </div>

  <div id="screen3" class="screen hidden">
      <header class="mb-6 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0 pb-6 border-b border-gray-200">
        <div id="report-nav" class="flex flex-wrap justify-center items-center gap-2">
            <button data-report-type="nps" class="btn">NPS推奨度 理由</button>
            <button data-report-type="feedback_i" class="btn">良かった点・悪かった点</button>
            <button data-report-type="feedback_j" class="btn">印象に残ったスタッフ</button>
            <button data-report-type="feedback_m" class="btn">お産にかかわるご意見</button>
            <button data-report-type="satisfaction_b" class="btn">満足度</button>
            <button data-report-type="satisfaction_c" class="btn">施設</button>
            <button data-report-type="satisfaction_d" class="btn">アクセス</button>
            <button data-report-type="satisfaction_e" class="btn">価格</button>
            <button data-report-type="satisfaction_f" class="btn">雰囲気</button>
            <button data-report-type="satisfaction_g" class="btn">スタッフ対応</button>
            <button data-report-type="satisfaction_h" class="btn">先生の説明</button>
            <button data-report-type="age" class="btn">年代</button>
            <button data-report-type="children" class="btn">お子様の数</button>
            <button data-report-type="income" class="btn">世帯年収</button>
        </div>
        <div class="flex items-center gap-4">
            <button id="pdf-export-btn" class="btn bg-gray-800 text-white hover:bg-gray-700">PDF出力</button>
            <button id="back-to-clinics" class="btn">院一覧へ戻る</button>
        </div>
      </header>
      <main class="card">
        <div class="text-center mb-8 pb-4 border-b">
            <h1 id="report-title" class="text-2xl font-bold"></h1>
            <p id="report-subtitle" class="text-sm text-gray-600 mt-2" style="white-space: pre-wrap;"></p>
        </div>

        <div id="slider-container" class="relative">
          <div id="slide-content" class="bg-gray-50 border p-6 md:p-8 rounded-lg min-h-[500px]">
            <h2 id="slide-header" class="text-xl font-bold mb-5 text-gray-800"></h2>
            <div id="slide-body" class="text-base leading-relaxed text-gray-700" style="white-space: pre-wrap;"></div>
          </div>
          <div id="pagination" class="flex items-center justify-center mt-6">
            <button id="prev-slide" class="btn">&lt; 前へ</button>
            <span id="page-indicator" class="mx-6 text-base font-semibold text-gray-600"></span>
            <button id="next-slide" class="btn">次へ &gt;</button>
          </div>
        </div>
      </main>
  </div>
  
  <div id="report-type-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-40 hidden">
    <div class="bg-white p-8 shadow-xl w-full max-w-md rounded-xl transform transition-all duration-300 scale-95 opacity-0">
      <h2 class="text-xl font-bold mb-6 text-center">表示するレポートを選択</h2>
      <div class="flex flex-wrap justify-center gap-3">
        <button data-report-type="nps" class="btn">NPS推奨度 理由</button>
        <button data-report-type="feedback_i" class="btn">良かった点・悪かった点</button>
        <button data-report-type="feedback_j" class="btn">印象に残ったスタッフ</button>
        <button data-report-type="feedback_m" class="btn">お産にかかわるご意見</button>
        <button data-report-type="satisfaction_b" class="btn">満足度</button>
        <button data-report-type="satisfaction_c" class="btn">施設</button>
        <button data-report-type="satisfaction_d" class="btn">アクセス</button>
        <button data-report-type="satisfaction_e" class="btn">価格</button>
        <button data-report-type="satisfaction_f" class="btn">雰囲気</button>
        <button data-report-type="satisfaction_g" class="btn">スタッフ対応</button>
        <button data-report-type="satisfaction_h" class="btn">先生の説明</button>
        <button data-report-type="age" class="btn">年代</button>
        <button data-report-type="children" class="btn">お子様の数</button>
        <button data-report-type="income" class="btn">世帯年収</button>
      </div>
      <div class="mt-8 text-center">
        <button id="cancel-report-selection" class="text-sm text-gray-600 hover:underline">キャンセル</button>
      </div>
    </div>
  </div>

<script>
  let selectedPeriod = {};
  let issuedReports = {}; // レポートデータを保持
  let currentClinicForModal = ''; // モーダル表示対象のクリニック名
  let slidesData = []; // コメント系レポートのスライドデータ
  let currentPage = 1; // コメント系レポートの現在ページ

  // Google Charts のロード完了を待つための Promise
  const googleChartsLoaded = new Promise(resolve => {
    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(resolve);
  });

  document.addEventListener('DOMContentLoaded', async () => {
    console.log('DOM Content Loaded. Initializing...');
    populateDateSelectors();
    
    // Google Charts のロードを待つ
    try {
        await googleChartsLoaded;
        console.log('Google Charts loaded successfully.');
    } catch (err) {
        console.error('Failed to load Google Charts:', err);
        alert('グラフライブラリの読み込みに失敗しました。ページを再読み込みしてください。');
        return; // チャートがなければ続行不可
    }

    // イベントリスナー設定
    setupEventListeners();
    console.log('Event listeners set up.');
  });

  function setupEventListeners() {
    document.getElementById('next-to-clinics').addEventListener('click', handleNextToClinics);
    document.getElementById('issue-btn').addEventListener('click', handleIssueReport);
    document.getElementById('issued-list-container').addEventListener('click', handleIssuedListClick);
    document.getElementById('report-type-modal').addEventListener('click', handleReportModalClick);
    document.getElementById('report-nav').addEventListener('click', handleReportNavClick);
    document.getElementById('cancel-report-selection').addEventListener('click', () => showReportModal(false));
    document.getElementById('prev-slide').addEventListener('click', handlePrevSlide);
    document.getElementById('next-slide').addEventListener('click', handleNextSlide);
    document.getElementById('back-to-clinics').addEventListener('click', () => showScreen('screen2'));
    document.getElementById('back-to-period').addEventListener('click', () => showScreen('screen1'));
    document.getElementById('pdf-export-btn').addEventListener('click', generatePdf); // PDFボタンはまだダミー
  }

  // --- 画面1: 期間選択 ---
  function populateDateSelectors() {
    const now = new Date();
    const currentYear = now.getFullYear();
    const startYearSelect = document.getElementById('start-year');
    const endYearSelect = document.getElementById('end-year');
    for (let i = 0; i < 5; i++) { const year = currentYear - i; startYearSelect.add(new Option(`${year}年`, year)); endYearSelect.add(new Option(`${year}年`, year)); }
    const startMonthSelect = document.getElementById('start-month');
    const endMonthSelect = document.getElementById('end-month');
    for (let i = 1; i <= 12; i++) { const month = String(i).padStart(2, '0'); startMonthSelect.add(new Option(`${i}月`, month)); endMonthSelect.add(new Option(`${i}月`, month)); }
    endMonthSelect.value = String(now.getMonth() + 1).padStart(2, '0');
    startMonthSelect.value = String(now.getMonth() + 1).padStart(2, '0');
  }

  function handleNextToClinics() {
    console.log('Next to clinics button clicked.');
    const startYear = document.getElementById('start-year').value;
    const startMonth = document.getElementById('start-month').value;
    const endYear = document.getElementById('end-year').value;
    const endMonth = document.getElementById('end-month').value;
    
    const startDate = new Date(`${startYear}-${startMonth}-01`);
    const endDate = new Date(`${endYear}-${endMonth}-01`);

    if (startDate > endDate) {
        console.warn('Start date is after end date.');
        alert('開始年月は終了年月より前に設定してください。');
        document.getElementById('start-year').classList.add('border-red-500');
        document.getElementById('start-month').classList.add('border-red-500');
        return;
    }
    
    document.getElementById('start-year').classList.remove('border-red-500');
    document.getElementById('start-month').classList.remove('border-red-500');
    
    selectedPeriod = { start: `${startYear}-${startMonth}`, end: `${endYear}-${endMonth}` };
    document.getElementById('period-display').textContent = `集計期間：${startYear}年${startMonth}月～${endYear}年${endMonth}月`;
    console.log('Selected period:', selectedPeriod);
    
    showScreen('screen2');
    // issuedReportsが空の場合のみクリニック一覧を読み込む
    if (Object.keys(issuedReports).length === 0) {
        console.log('No issued reports found, loading clinics...');
        loadClinics();
    } else {
        console.log('Issued reports exist, not reloading clinics.');
    }
  }

  // --- 画面2: クリニック選択 & レポート発行 ---
  async function loadClinics() {
    console.log('Executing loadClinics function...');
    showLoading(true, 'クリニック一覧を読み込み中...');
    const container = document.getElementById('clinic-list-container');
    container.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">読み込み中...</p>';
    
    try {
      console.log('Fetching /api/getClinicList...');
      const response = await fetch('/api/getClinicList');
      console.log('Fetch response status:', response.status);

      if (!response.ok) {
        const errorText = await response.text();
        console.error('Server responded with error:', response.status, errorText);
        throw new Error(`サーバーエラー (${response.status}): ${errorText}`);
      }
      
      const clinics = await response.json();
      console.log('Received clinics:', clinics);

      container.innerHTML = ''; // コンテナをクリア
      if (!Array.isArray(clinics)) {
          console.error('Received data is not an array:', clinics);
          throw new Error('サーバーから予期しない形式のデータを受信しました。');
      }

      if (clinics.length === 0) {
          console.log('No clinics found.');
          container.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">対象クリニックが見つかりませんでした。</p>';
      } else {
          clinics.forEach(name => {
            const div = document.createElement('div');
            div.className = 'flex items-center p-2 rounded-md hover:bg-gray-100';
            div.innerHTML = `
                <input type="checkbox" id="clinic-${name}" name="clinic" value="${name}" class="mr-3 h-4 w-4 rounded border-gray-300 text-gray-800 focus:ring-gray-800 cursor-pointer">
                <label for="clinic-${name}" class="text-sm select-none cursor-pointer">${name}</label>
            `;
            container.appendChild(div);
          });
          console.log('Clinic list populated.');
          
          // チェックボックス変更時のイベントリスナーを設定
          container.removeEventListener('change', handleClinicCheckboxChange); // 古いリスナーを削除
          container.addEventListener('change', handleClinicCheckboxChange);
      }
      showLoading(false);

    } catch (err) {
      console.error('!!! Failed to load clinics:', err);
      container.innerHTML = `<p class="text-sm text-red-500 text-center py-4">クリニック一覧の読み込みに失敗しました。<br>${err.message}</p>`;
      showLoading(false);
    }
  }
  
  // チェックボックス変更時のハンドラ関数
  function handleClinicCheckboxChange() {
      const checked = document.querySelectorAll('#clinic-list-container input[type="checkbox"]:checked').length;
      document.getElementById('issue-btn').disabled = checked === 0;
  }

  // レポート発行ボタンの処理
  async function handleIssueReport() {
    console.log('Issue report button clicked.');
    showLoading(true, 'レポートデータを取得中...');
    const selectedClinics = Array.from(document.querySelectorAll('#clinic-list-container input:checked')).map(cb => cb.value);
    console.log('Selected clinics for report:', selectedClinics);
    
    try {
      console.log('Posting to /api/getReportData...');
      const response = await fetch('/api/getReportData', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          period: selectedPeriod,
          selectedClinics: selectedClinics
        })
      });
      console.log('Fetch response status:', response.status);

      if (!response.ok) {
        const errorText = await response.text();
        console.error('Server responded with error:', response.status, errorText);
        throw new Error(`サーバーエラー (${response.status}): ${errorText}`);
      }
      
      const data = await response.json();
      console.log('Received report data:', data);

      const timestamp = new Date().toLocaleString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
      let reportGenerated = false;
      Object.keys(data).forEach(clinicName => {
          if (selectedClinics.includes(clinicName)) { // 選択されたクリニックのみを対象
              issuedReports[clinicName] = { ...data[clinicName], timestamp };
              reportGenerated = true;
              console.log(`Report data stored for ${clinicName}`);
          }
      });
      
      if (reportGenerated) {
        updateIssuedList(); // 発行済みリストを更新
        currentClinicForModal = selectedClinics[0]; // 最初のクリニックをモーダル用に設定
        if (currentClinicForModal && issuedReports[currentClinicForModal]) {
            console.log(`Showing report type modal for ${currentClinicForModal}`);
            showReportModal(true);
        } else {
             console.warn('Report generated but no data found for the first selected clinic:', currentClinicForModal);
        }
      } else {
          console.warn('Report data received, but it was empty or did not contain selected clinics.');
          alert('レポートデータの取得に失敗したか、対象データがありませんでした。');
      }
      
      showLoading(false);

    } catch (err) {
      console.error('!!! Failed to issue report:', err);
      alert(`レポートの発行に失敗しました。\n${err.message}`);
      showLoading(false);
    }
  }
  
  // 発行済みリストの更新
  function updateIssuedList() {
    const container = document.getElementById('issued-list-container');
    container.innerHTML = '';
    const clinicNames = Object.keys(issuedReports);
    if (clinicNames.length === 0) { container.innerHTML = '<p class="text-sm text-gray-500 text-center py-8">まだ発行されたレポートはありません。</p>'; return; }
    clinicNames.forEach(name => { const div = document.createElement('div'); div.className = 'p-4 border rounded-lg cursor-pointer hover:bg-gray-50 hover:shadow-md transition-all duration-200'; div.dataset.clinicName = name; div.innerHTML = `<p class="font-bold text-base">${name}</p><p class="text-xs text-gray-500 mt-1">発行日時: ${issuedReports[name].timestamp}</p>`; container.appendChild(div); });
    console.log('Issued list updated.');
  }

  // --- 画面3: レポート表示 ---

  function handleIssuedListClick(e) {
      const target = e.target.closest('[data-clinic-name]');
      if (target) {
          currentClinicForModal = target.dataset.clinicName;
          if (issuedReports[currentClinicForModal]) {
              showReportModal(true);
          }
      }
  }

  function handleReportModalClick(e) {
      const reportType = e.target.dataset.reportType;
      if (reportType) {
          showReportModal(false);
          setTimeout(() => prepareAndShowReport(reportType), 300); // モーダルが閉じてから
      }
  }

  function handleReportNavClick(e) {
    const reportType = e.target.dataset.reportType;
    if (reportType) {
      prepareAndShowReport(reportType);
    }
  }
  
  function prepareAndShowReport(reportType) {
    showLoading(true, 'レポートを準備中...');
    updateNavActiveState(reportType);

    const clinicData = issuedReports[currentClinicForModal];
    if (!clinicData) {
        showLoading(false);
        return;
    }

    slidesData = [];
    document.getElementById('pagination').style.display = 'flex';
    document.getElementById('slide-body').style.whiteSpace = 'pre-wrap';
    document.getElementById('slide-header').innerHTML = '';
    document.getElementById('slide-body').innerHTML = '';
    
    let isChartReport = false;
    let isBarChart = false;

    // --- コメント系 ---
    if (reportType === 'nps') {
        const { totalCount, results } = clinicData.npsData;
        prepareNpsSlides(results, `アンケート結果 ー NPS推奨度 理由 (全${totalCount}件) ー`);
    } else if (reportType === 'feedback_i') {
        prepareCommentSlides(clinicData.feedbackData.i_column, 'アンケート結果 ー 良かった点・悪かった点など ー');
    } else if (reportType === 'feedback_j') {
        prepareCommentSlides(clinicData.feedbackData.j_column, 'アンケート結果 ー 印象に残ったスタッフ ー');
    } else if (reportType === 'feedback_m') {
        prepareCommentSlides(clinicData.feedbackData.m_column, 'アンケート結果 ー お産にかかわるご意見・ご感想 ー');
    
    // --- 円グラフ系 ---
    } else if (reportType === 'satisfaction_b') {
        prepareChartShell('アンケート結果 ー満足度ー', 'ご出産された産婦人科医院への満足度について、教えてください。\n＜5段階評価＞ 5:非常に満足〜 1:非常に不満');
        isChartReport = true;
    } else if (reportType === 'satisfaction_c') {
        prepareChartShell('アンケート結果 ー施設の充実度/快適さー', '＜5段階評価＞ 5:非常に満足〜 1:非常に不満');
        isChartReport = true;
    } else if (reportType === 'satisfaction_d') {
        prepareChartShell('アンケート結果 ーアクセスの良さー', '＜5段階評価＞ 5:非常に満足〜 1:非常に不満');
        isChartReport = true;
    } else if (reportType === 'satisfaction_e') {
        prepareChartShell('アンケート結果 ー価格ー', '＜5段階評価＞ 5:非常に満足〜 1:非常に不満');
        isChartReport = true;
    } else if (reportType === 'satisfaction_f') {
        prepareChartShell('アンケート結果 ー病院の雰囲気ー', '＜5段階評価＞ 5:非常に満足〜 1:非常に不満');
        isChartReport = true;
    } else if (reportType === 'satisfaction_g') {
        prepareChartShell('アンケート結果 ースタッフの対応ー', '＜5段階評価＞ 5:非常に満足〜 1:非常に不満');
        isChartReport = true;
    } else if (reportType === 'satisfaction_h') {
        prepareChartShell('アンケート結果 ー先生の診断・説明ー', '＜5段階評価＞ 5:非常に満足〜 1:非常に不満');
        isChartReport = true;
    } else if (reportType === 'age') {
        prepareChartShell('アンケート結果 ー回答者の年代ー', '');
        isChartReport = true;
    } else if (reportType === 'children') {
        prepareChartShell('アンケート結果 ーお子様の数ー', '※集計キー: 1人, 2人, 3人, 4人, 5人以上');
        isChartReport = true;
    
    // --- 棒グラフ系 ---
    } else if (reportType === 'income') {
        prepareChartShell('アンケート結果 ーご回答者さまの世帯年収ー', 'ご出産された方の世帯年収について教えてください。', true);
        isChartReport = true;
        isBarChart = true;
    }

    // スライド描画処理 (コメント系の場合)
    if (slidesData.length > 0) {
      currentPage = 1;
      renderSlide(currentPage);
    } else if (slidesData.length === 0 && (reportType.startsWith('nps') || reportType.startsWith('feedback'))) {
      document.getElementById('slide-header').innerHTML = '';
      document.getElementById('slide-body').innerHTML = '<p class="text-center text-gray-500">該当するデータはありませんでした。</p>';
      document.getElementById('pagination').style.display = 'none';
    }
    
    showScreen('screen3');
    
    if (isChartReport) {
      // 画面表示がDOMに反映された後にグラフを描画する
      setTimeout(() => {
          try {
              let data;
              if (reportType.startsWith('satisfaction')) {
                  data = clinicData.satisfactionData[reportType.split('_')[1] + '_column'];
                  drawSatisfactionCharts(data.results);
              } else if (reportType === 'age') {
                  data = clinicData.ageData;
                  drawSatisfactionCharts(data.results);
              } else if (reportType === 'children') {
                  data = clinicData.childrenCountData;
                  drawSatisfactionCharts(data.results);
              } else if (reportType === 'income') {
                  data = clinicData.incomeData;
                  drawIncomeCharts(data);
              }
          } catch (e) {
              console.error('Chart drawing error:', e);
              document.getElementById('slide-body').innerHTML = '<p class="text-center text-red-500">グラフの描画に失敗しました。</p>';
          } finally {
              showLoading(false);
          }
      }, 100); 
    } else {
      // コメント系レポート
      showLoading(false);
    }
  }

  // NPS専用 (スコア別グループ化)
  function prepareNpsSlides(results, title) {
      document.getElementById('report-title').textContent = title;
      document.getElementById('report-subtitle').textContent = '';
      const maxLinesPerPage = 20;
      
      if (!results) {
        console.warn('NPS results are missing.');
        return;
      }
      
      const scores = Object.keys(results).map(Number).sort((a, b) => b - a);
      
      scores.forEach(score => {
          const reasons = results[score];
          if (!reasons || reasons.length === 0) return;

          let currentLineCount = 0;
          let currentPageBody = '';
          
          reasons.forEach((reason, index) => {
              const reasonText = `・ ${reason}`;
              const reasonLines = (reasonText.match(/\n/g) || []).length + 1;

              if (currentLineCount > 0 && (currentLineCount + reasonLines) > maxLinesPerPage) {
                  slidesData.push({
                      header: `推奨度 ${score} (${reasons.length}人)`,
                      body: currentPageBody
                  });
                  currentPageBody = reasonText;
                  currentLineCount = reasonLines;
              } else {
                  currentPageBody += (currentLineCount === 0 ? '' : '\n') + reasonText;
                  currentLineCount += reasonLines;
              }
          });

          if (currentPageBody) {
              slidesData.push({
                  header: `推奨度 ${score} (${reasons.length}人)`,
                  body: currentPageBody
              });
          }
      });
  }

  // 汎用コメント (Feedback_i, j, m)
  function prepareCommentSlides(data, title) {
      if (!data) {
        console.warn(`Feedback data for ${title} is missing.`);
        data = { totalCount: 0, results: [] }; // フォールバック
      }
      const { totalCount, results } = data;
      document.getElementById('report-title').textContent = `${title} (全${totalCount}件)`;
      document.getElementById('report-subtitle').textContent = '';
      const maxLinesPerPage = 20;

      if (results && results.length > 0) {
          let currentLineCount = 0;
          let currentPageBody = '';

          results.forEach((item, index) => {
              const itemText = `・ ${item}`;
              const itemLines = (itemText.match(/\n/g) || []).length + 1;

              if (currentLineCount > 0 && (currentLineCount + itemLines) > maxLinesPerPage) {
                  slidesData.push({ header: '', body: currentPageBody });
                  currentPageBody = itemText;
                  currentLineCount = itemLines;
              } else {
                  currentPageBody += (currentLineCount === 0 ? '' : '\n') + itemText;
                  currentLineCount += itemLines;
              }
          });

          if (currentPageBody) {
              slidesData.push({ header: '', body: currentPageBody });
          }
      }
  }

  // グラフ描画用のHTMLコンテナを準備する
  function prepareChartShell(title, subtitle, isBarChart = false) {
      document.getElementById('report-title').textContent = title;
      document.getElementById('report-subtitle').textContent = subtitle;
      document.getElementById('pagination').style.display = 'none';
      document.getElementById('slide-body').style.whiteSpace = 'normal';

      const chartId = isBarChart ? 'bar-chart' : 'pie-chart';
      const heightClass = isBarChart ? 'h-[350px]' : 'h-[400px]';

      document.getElementById('slide-body').innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
              <div class="flex flex-col items-center">
                  <h3 class="font-bold text-lg mb-4 text-center">貴院の結果</h3>
                  <div id="clinic-${chartId}" class="w-full ${heightClass}"></div>
              </div>
              <div class="flex flex-col items-center">
                  <h3 class="font-bold text-lg mb-4 text-center">（参照）全体平均</h3>
                  <div id="average-${chartId}" class="w-full ${heightClass}"></div>
              </div>
          </div>
      `;
  }

  function renderSlide(page) {
    if (page < 1 || page > slidesData.length) return;
    
    const slide = slidesData[page - 1];
    document.getElementById('slide-header').innerHTML = slide.header;
    document.getElementById('slide-body').innerHTML = slide.body;
    document.getElementById('page-indicator').textContent = `${page} / ${slidesData.length}`;

    document.getElementById('prev-slide').disabled = (page === 1);
    document.getElementById('next-slide').disabled = (page === slidesData.length);
  }

  function drawSatisfactionCharts(clinicChartData) {
      const chartOptions = {
          is3D: true,
          chartArea: { left: '5%', top: '5%', width: '90%', height: '90%' },
          pieSliceText: 'percentage',
          pieSliceTextStyle: { color: 'black', fontSize: 16, bold: true },
          legend: { position: 'labeled', textStyle: { color: 'black', fontSize: 14 } },
          tooltip: { showColorCode: true, textStyle: { fontSize: 14 }, trigger: 'focus' },
          colors: ['#4285F4', '#DB4437', '#F4B400', '#0F9D58', '#990099'],
      };

      const clinicChartDiv = document.getElementById('clinic-pie-chart');
      if (clinicChartData && clinicChartData.length > 1) {
        const clinicData = google.visualization.arrayToDataTable(clinicChartData);
        const clinicChart = new google.visualization.PieChart(clinicChartDiv);
        clinicChart.draw(clinicData, chartOptions);
      } else {
        clinicChartDiv.innerHTML = '<div class="flex items-center justify-center h-full"><p class="text-gray-500">データがありません</p></div>';
      }

      // TODO: この平均データは現在「満足度」固定。将来的にはレポートタイプ別に平均データを渡す必要がある。
      const averageData = google.visualization.arrayToDataTable([
          ['満足度', '割合'],
          ['非常に満足', 73.5], ['満足', 24.2], ['ふつう', 2.0], ['不満', 0.3], ['非常に不満', 0]
      ]);
      const averageChart = new google.visualization.PieChart(document.getElementById('average-pie-chart'));
      averageChart.draw(averageData, chartOptions);
  }

  function drawIncomeCharts({ results, totalCount }) {
      const chartOptions = {
        legend: { position: 'none' },
        colors: ['#DE5D83'],
        annotations: {
          textStyle: { fontSize: 12, color: 'black', auraColor: 'none' },
          alwaysOutside: false,
          stem: { color: 'transparent' }
        },
        vAxis: { format: '#\'%\'', viewWindow: { min: 0 } },
        hAxis: {}
      };

      const clinicChartDiv = document.getElementById('clinic-bar-chart');
      if (totalCount > 0) {
        const clinicData = google.visualization.arrayToDataTable(results);
        const clinicChart = new google.visualization.ColumnChart(clinicChartDiv);
        clinicChart.draw(clinicData, chartOptions);
      } else {
        clinicChartDiv.innerHTML = '<div class="flex items-center justify-center h-full"><p class="text-gray-500">データがありません</p></div>';
      }
      
      const averageData = google.visualization.arrayToDataTable([
          ['評価', '割合', { role: 'annotation' }],
          ['1', 1, '1%'], ['2', 2, '2%'], ['3', 7, '7%'], ['4', 12, '12%'], ['5', 16, '16%'],
          ['6', 16, '16%'], ['7', 13, '13%'], ['8', 12, '12%'], ['9', 8, '8%'], ['10', 15, '15%']
      ]);
      const averageChart = new google.visualization.ColumnChart(document.getElementById('average-bar-chart'));
      averageChart.draw(averageData, chartOptions);
  }
  
  function handlePrevSlide() {
    if (currentPage > 1) {
      currentPage--;
      renderSlide(currentPage);
    }
  }

  function handleNextSlide() {
    if (currentPage < slidesData.length) {
      currentPage++;
      renderSlide(currentPage);
    }
  }
  
  // --- 汎用関数 ---
  
  function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(el => el.classList.add('hidden'));
    document.getElementById(screenId).classList.remove('hidden');
  }

  function showLoading(isLoading, message = '') {
    const overlay = document.getElementById('loading-overlay');
    const msgEl = document.getElementById('loading-message');
    
    if (isLoading) {
      msgEl.textContent = message;
      overlay.classList.remove('hidden');
    } else {
      overlay.classList.add('hidden');
      msgEl.textContent = '';
    }
  }

  function showReportModal(show) {
    const modal = document.getElementById('report-type-modal');
    const modalContent = modal.querySelector('div');
    if (show) {
        modal.classList.remove('hidden');
        setTimeout(() => {
            modalContent.classList.remove('scale-95', 'opacity-0');
        }, 10);
    } else {
        modalContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 300);
    }
  }

  function updateNavActiveState(activeType) {
    const navButtons = document.querySelectorAll('#report-nav .btn');
    navButtons.forEach(btn => {
      if (btn.dataset.reportType === activeType) {
        btn.classList.add('btn-active');
      } else {
        btn.classList.remove('btn-active');
      }
    });
  }
  
  /**
   * PDF生成 (ダミー / サーバーサイドへ移植)
   */
  async function generatePdf() {
      console.log('PDF export button clicked.');
      alert('PDF生成機能は現在、Node.jsサーバー側へ移植中です。\n（/generate-pdf エンドポイントを呼び出すように変更します）');
      
      showLoading(true, 'PDFを生成中...');
      
      try {
        // サーバーの /generate-pdf エンドポイントを呼び出す
        const response = await fetch('/generate-pdf');
        
        if (!response.ok) {
          throw new Error(`サーバーエラー: ${response.statusText}`);
        }
        
        // レスポンス (PDF) を Blobとして取得
        const pdfBlob = await response.blob();
        
        // Blobからダウンロード用のURLを生成
        const url = window.URL.createObjectURL(pdfBlob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = 'report.pdf'; // ダミーのファイル名
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();
        
        showLoading(false);
        
      } catch (error) {
          console.error('PDF generation error:', error);
          alert('PDFの生成に失敗しました。\n' + error.message);
          showLoading(false);
      }
  }
</script>
</body>
</html>
