<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>レポートアプリ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.1.1/wordcloud2.min.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Noto Sans JP',sans-serif;background-color:#f8f7f7;}
    .btn{@apply py-2 px-6 border border-gray-800 text-gray-800 transition-all duration-300 rounded-md text-sm font-bold tracking-wider shadow-sm whitespace-nowrap;}
    .btn:hover:not(:disabled){@apply bg-gray-800 text-white shadow-md transform -translate-y-px;}
    .btn:disabled{@apply border-gray-300 text-gray-400 cursor-not-allowed bg-gray-100 shadow-none;}
    .btn-active{@apply bg-gray-800 text-white shadow-md transform -translate-y-px;}
    .select-box{@apply block w-full p-3 bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-800 focus:border-transparent transition-shadow;}
    .screen{@apply w-full max-w-7xl mx-auto p-4 md:p-8;}
    .card{@apply bg-white p-6 md:p-8 shadow-lg rounded-xl border border-gray-200;}
    #loading-overlay > div > div { border-top-color: #333; border-bottom-color: #333; }
    #word-cloud-canvas { width: 100%; height: 400px; border: 1px solid #e5e7eb; border-radius: 0.5rem; background-color: #f9fafb; cursor: default; }
    .chart-container { min-height: 200px; height: 500px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; background-color: #f9fafb;}
    
    /* ▼▼▼ 詳細分析タブ (CSS追加) ▼▼▼ */
    .tab-button { @apply px-4 py-2 text-sm font-medium border-b-2 border-transparent hover:border-gray-300 hover:text-gray-700 whitespace-nowrap cursor-pointer; }
    .tab-button.active { @apply border-indigo-500 text-indigo-600; }
    .tab-content { @apply p-4 border border-t-0 rounded-b-md bg-gray-50;}
    /* ▲▲▲ 詳細分析タブ (CSS追加) ▲▲▲ */
  </style>
</head>
<body class="text-gray-900">

  <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50 hidden"><div class="flex flex-col items-center"><div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-gray-800"></div><p id="loading-message" class="mt-4 text-lg font-semibold text-gray-800"></p></div></div>

  <div id="screen1" class="screen"> <div class="card max-w-lg mx-auto mt-12"> <div class="text-center mb-8"> <h1 class="text-2xl font-bold text-gray-800">集計期間の選択</h1> <p class="text-sm text-gray-500 mt-2">レポートを生成する期間を設定してください。</p> </div> <div class="space-y-6"> <div> <label for="start-year" class="font-bold text-gray-700 mb-2 block text-sm">開始年月</label> <div class="grid grid-cols-2 gap-4"> <select id="start-year" class="select-box"></select> <select id="start-month" class="select-box"></select> </div> </div> <div> <label for="end-year" class="font-bold text-gray-700 mb-2 block text-sm">終了年月</label> <div class="grid grid-cols-2 gap-4"> <select id="end-year" class="select-box"></select> <select id="end-month" class="select-box"></select> </div> </div> <div class="pt-4 border-t mt-6"> <button id="next-to-clinics" class="btn w-full bg-gray-800 text-white hover:bg-gray-700">次へ進む</button> </div> </div> </div> </div>

  <div id="screen2" class="screen hidden"> <header class="flex justify-between items-center mb-6 pb-4 border-b"> <button id="back-to-period" class="btn">&lt; 期間選択へ戻る</button> <div id="period-display" class="text-base font-semibold text-gray-700 bg-white py-2 px-4 rounded-lg shadow-sm border"></div> </header> <main class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:px-8"> <section class="card"> <h2 class="text-xl font-bold mb-5">1. クリニックを選択</h2> <div id="clinic-list-container" class="space-y-3 max-h-96 overflow-y-auto pr-2 border rounded-lg p-4 bg-gray-50"> <p class="text-sm text-gray-500 text-center py-4">読み込み中...</p> </div> <div class="mt-6 text-right"> <button id="issue-btn" class="btn bg-gray-800 text-white hover:bg-gray-700" disabled>レポート発行</button> </div> </section> <section class="card"> <h2 class="text-xl font-bold mb-5">2. 発行済みレポートを閲覧</h2> <div id="issued-list-container" class="space-y-3"> <p class="text-sm text-gray-500 text-center py-8">まだ発行されたレポートはありません。</p> </div> </section> </main> </div>

  <div id="screen3" class="screen hidden">
    <header class="mb-6 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0 pb-6 border-b border-gray-200">
      
      <div id="report-nav" class="flex flex-wrap justify-center items-center gap-2">
        <button data-report-type="nps_score" class="btn">NPS値集計</button>
        <button data-report-type="recommendation" class="btn">おすすめ理由</button>
        <button data-report-type="nps" class="btn">NPS理由</button>
        <button data-report-type="feedback_i" class="btn">良かった点</button>
        <button data-report-type="feedback_j" class="btn">印象スタッフ</button>
        <button data-report-type="feedback_m" class="btn">お産意見</button>
        <button data-report-type="municipality" class="btn">市区町村</button>
        <button data-report-type="satisfaction_b" class="btn">満足度</button>
        <button data-report-type="satisfaction_c" class="btn">施設</button>
        <button data-report-type="satisfaction_d" class="btn">アクセス</button>
        <button data-report-type="satisfaction_e" class="btn">価格</button>
        <button data-report-type="satisfaction_f" class="btn">雰囲気</button>
        <button data-report-type="satisfaction_g" class="btn">スタッフ対応</button>
        <button data-report-type="satisfaction_h" class="btn">先生説明</button>
        <button data-report-type="age" class="btn">年代</button>
        <button data-report-type="children" class="btn">お子様数</button>
        <button data-report-type="income" class="btn">世帯年収</button>
        <button data-analysis-type="L" class="btn !border-blue-600 !text-blue-600 hover:!bg-blue-600 hover:!text-white">WC-NPS</button>
        <button data-analysis-type="I" class="btn !border-blue-600 !text-blue-600 hover:!bg-blue-600 hover:!text-white">WC-良い点</button>
        <button data-analysis-type="J" class="btn !border-blue-600 !text-blue-600 hover:!bg-blue-600 hover:!text-white">WC-スタッフ</button>
        <button data-analysis-type="M" class="btn !border-blue-600 !text-blue-600 hover:!bg-blue-600 hover:!text-white">WC-お産</button>
        <button data-detailed-analysis-type="L" class="btn !border-purple-600 !text-purple-600 hover:!bg-purple-600 hover:!text-white">AI分析-NPS</button>
        <button data-detailed-analysis-type="I_good" class="btn !border-purple-600 !text-purple-600 hover:!bg-purple-600 hover:!text-white">AI分析-良い点</button>
        <button data-detailed-analysis-type="I_bad" class="btn !border-purple-600 !text-purple-600 hover:!bg-purple-600 hover:!text-white">AI分析-悪い点</button>
        <button data-detailed-analysis-type="J" class="btn !border-purple-600 !text-purple-600 hover:!bg-purple-600 hover:!text-white">AI分析-スタッフ</button>
        <button data-detailed-analysis-type="M" class="btn !border-purple-600 !text-purple-600 hover:!bg-purple-600 hover:!text-white">AI分析-お産</button>
      </div>
      <div class="flex items-center gap-4">
        <button id="pdf-export-btn" class="btn bg-gray-800 text-white hover:bg-gray-700">PDF出力</button>
        <button id="back-to-clinics" class="btn">院一覧へ戻る</button>
      </div>
    </header>
    <main class="card">
      <div class="text-center mb-8 pb-4 border-b">
        <h1 id="report-title" class="text-2xl font-bold"></h1>
        <p id="report-subtitle" class="text-sm text-gray-600 mt-2" style="white-space: pre-wrap;"></p>
      </div>
      <div id="slider-container" class="relative">
        <div id="slide-content" class="bg-gray-50 border p-6 md:p-8 rounded-lg min-h-[500px]">
          <h2 id="slide-header" class="text-xl font-bold mb-5 text-gray-800"></h2>
          <div id="slide-body" class="text-base leading-relaxed text-gray-700" style="white-space: pre-wrap;"></div>
        </div>
        <div id="pagination" class="flex items-center justify-center mt-6">
          <button id="prev-slide" class="btn">&lt; 前へ</button>
          <span id="page-indicator" class="mx-6 text-base font-semibold text-gray-600"></span>
          <button id="next-slide" class="btn">次へ &gt;</button>
        </div>
      </div>
    </main>
  </div>

  <div id="screen4" class="screen hidden"> <header class="mb-6 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0 pb-6 border-b border-gray-200"> <div class="flex items-center gap-4 ml-auto"> <button id="back-to-clinics-from-analysis" class="btn">院一覧へ戻る</button> </div> </header> <main class="card"> <div class="text-center mb-8 pb-4 border-b"> <h1 id="analysis-title" class="text-2xl font-bold"></h1> <p class="text-sm text-gray-500 mt-2"> 文章中に出現する単語の頻出度を表しています。単語ごとに表示されている「スコア」の大きさは、その単語がどれだけ特徴的であるかを表しています。<br> 通常はその単語の出現回数が多いほどスコアが高くなるが、「言う」や「思う」など、どの文書にもよく現れる単語についてはスコアが低めになります。 </p> </div> <div class="grid grid-cols-1 md:grid-cols-2 gap-8"> <div class="space-y-4"> <div id="noun-chart-container" class="chart-container"> <h3 class="font-bold text-center mb-2 text-blue-600">名詞</h3> <div id="noun-chart"></div> </div> <div id="verb-chart-container" class="chart-container"> <h3 class="font-bold text-center mb-2 text-red-600">動詞</h3> <div id="verb-chart"></div> </div> <div id="adj-chart-container" class="chart-container"> <h3 class="font-bold text-center mb-2 text-green-600">形容詞</h3> <div id="adj-chart"></div> </div> <div id="int-chart-container" class="chart-container"> <h3 class="font-bold text-center mb-2 text-gray-600">感動詞</h3> <div id="int-chart"></div> </div> </div> <div class="space-y-6"> <div> <p class="text-sm text-gray-600"> ワードクラウドスコアが高い単語を複数選び出し、その値に応じた大きさで図示しています。<br> 単語の色は品詞の種類で異なる。<br> <span class="text-blue-600 font-semibold">青色=名詞</span>、 <span class="text-red-600 font-semibold">赤色=動詞</span>、 <span class="text-green-600 font-semibold">緑色=形容詞</span>、 <span class="text-gray-600 font-semibold">灰色=感動詞</span> </p> </div> <div id="word-cloud-container"> <canvas id="word-cloud-canvas"></canvas> </div> <div id="analysis-error" class="text-red-500 text-sm text-center hidden"></div> </div> </div> </main> </div>

  <div id="report-type-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-40 hidden"><div class="bg-white p-8 shadow-xl w-full max-w-md rounded-xl transform transition-all duration-300 scale-95 opacity-0"><h2 class="text-xl font-bold mb-6 text-center">表示するレポートを選択</h2><div class="flex flex-wrap justify-center gap-3"><button data-report-type="nps" class="btn">NPS推奨度 理由</button><button data-report-type="feedback_i" class="btn">良かった点・悪かった点</button><button data-report-type="feedback_j" class="btn">印象に残ったスタッフ</button><button data-report-type="feedback_m" class="btn">お産にかかわるご意見</button><button data-report-type="satisfaction_b" class="btn">満足度</button><button data-report-type="satisfaction_c" class="btn">施設</button><button data-report-type="satisfaction_d" class="btn">アクセス</button><button data-report-type="satisfaction_e" class="btn">価格</button><button data-report-type="satisfaction_f" class="btn">雰囲気</button><button data-report-type="satisfaction_g" class="btn">スタッフ対応</button><button data-report-type="satisfaction_h" class="btn">先生の説明</button><button data-report-type="age" class="btn">年代</button><button data-report-type="children" class="btn">お子様の数</button><button data-report-type="income" class="btn">世帯年収</button></div><div class="mt-8 text-center"><button id="cancel-report-selection" class="text-sm text-gray-600 hover:underline">キャンセル</button></div></div></div>

  <div id="screen5" class="screen hidden">
    <header class="mb-6 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0 pb-6 border-b border-gray-200">
        <div class="text-center md:text-left">
            <h1 id="detailed-analysis-title" class="text-2xl font-bold text-gray-800">詳細分析レポート</h1>
            <p id="detailed-analysis-subtitle" class="text-sm text-gray-500 mt-1"></p>
        </div>
        <div class="flex items-center gap-4">
            <button id="edit-detailed-analysis-btn" class="btn !border-blue-600 !text-blue-600 hover:!bg-blue-600 hover:!text-white">編集</button>
            <button id="save-detailed-analysis-btn" class="btn !border-green-600 !text-green-600 hover:!bg-green-600 hover:!text-white hidden">保存</button>
            <button id="cancel-edit-detailed-analysis-btn" class="btn !border-red-600 !text-red-600 hover:!bg-red-600 hover:!text-white hidden">キャンセル</button>
            <button id="back-to-clinics-from-detailed-analysis" class="btn">院一覧へ戻る</button>
        </div>
    </header>
    <main class="card">
        <div class="border-b border-gray-200 mb-4">
            <nav class="flex -mb-px" aria-label="Tabs">
                <button id="tab-analysis" data-tab-id="analysis" class="tab-button active">分析と考察</button>
                <button id="tab-suggestions" data-tab-id="suggestions" class="tab-button">改善提案</button>
                <button id="tab-overall" data-tab-id="overall" class="tab-button">総評</button>
            </nav>
        </div>
        
        <div id="detailed-analysis-content-area">
            <div id="content-analysis" class="tab-content">
                <h2 id="analysis-title-area" class="text-xl font-bold mb-4 text-gray-800" data-key-title="analysis.title"></h2>
                <div id="analysis-themes-area" class="space-y-6" data-key-list="analysis.themes">
                    </div>
            </div>
            <div id="content-suggestions" class="tab-content hidden">
                <h2 id="suggestions-title-area" class="text-xl font-bold mb-4 text-gray-800" data-key-title="suggestions.title"></h2>
                <div id="suggestions-items-area" class="space-y-6" data-key-list="suggestions.items">
                    </div>
            </div>
            <div id="content-overall" class="tab-content hidden">
                <h2 id="overall-title-area" class="text-xl font-bold mb-4 text-gray-800" data-key-title="overall.title"></h2>
                <div id="overall-summary-area" class="text-base leading-relaxed text-gray-700 whitespace-pre-wrap" data-key-summary="overall.summary">
                    </div>
            </div>
        </div>
        
        <div id="detailed-analysis-error" class="text-red-500 text-sm text-center hidden p-4"></div>
    </main>
  </div>
  <script>
  // --- グローバル変数 (変更なし + 追加) ---
  let selectedPeriod = {}; let issuedReports = {}; let currentClinicForModal = ''; let slidesData = []; let currentPage = 1; let currentAnalysisTarget = 'L';
  
  // ▼▼▼ 詳細分析用グローバル変数 (追加) ▼▼▼
  let currentDetailedAnalysisType = 'L'; // 詳細分析の対象タイプ (L, I_good, I_bad, J, M)
  let detailedAnalysisResultsCache = {}; // 詳細分析結果キャッシュ (メモリ保持)
  let isEditingDetailedAnalysis = false; // 詳細分析編集中フラグ
  // ▲▲▲ 詳細分析用グローバル変数 (追加) ▲▲▲


  // --- Google Charts ロード (変更なし) ---
  const googleChartsLoaded = new Promise(resolve => { google.charts.load('current', {'packages':['corechart', 'bar']}); google.charts.setOnLoadCallback(resolve); });

  // --- 初期化 (変更なし) ---
  document.addEventListener('DOMContentLoaded', async () => { console.log('DOM Loaded.'); populateDateSelectors(); try { await googleChartsLoaded; console.log('Charts loaded.'); } catch (err) { console.error('Chart load fail:', err); alert('グラフライブラリ読込失敗'); return; } setupEventListeners(); console.log('Listeners setup.'); });

  // --- イベントリスナー設定 (変更あり) ---
  function setupEventListeners() {
    document.getElementById('next-to-clinics').addEventListener('click', handleNextToClinics);
    document.getElementById('issue-btn').addEventListener('click', handleIssueReport);
    document.getElementById('issued-list-container').addEventListener('click', handleIssuedListClick);
    document.getElementById('report-type-modal').addEventListener('click', handleReportModalClick);
    document.getElementById('report-nav').addEventListener('click', handleReportNavClick);
    document.getElementById('cancel-report-selection').addEventListener('click', () => showReportModal(false));
    document.getElementById('prev-slide').addEventListener('click', handlePrevSlide);
    document.getElementById('next-slide').addEventListener('click', handleNextSlide);
    document.getElementById('back-to-clinics').addEventListener('click', () => showScreen('screen2'));
    document.getElementById('back-to-period').addEventListener('click', () => showScreen('screen1'));
    document.getElementById('pdf-export-btn').addEventListener('click', generatePdf);
    document.getElementById('back-to-clinics-from-analysis').addEventListener('click', () => showScreen('screen2'));

    // ▼▼▼ 詳細分析(Screen 5)用リスナー (追加) ▼▼▼
    document.querySelectorAll('#screen5 .tab-button').forEach(button => { button.addEventListener('click', handleTabClick); });
    document.getElementById('edit-detailed-analysis-btn').addEventListener('click', toggleEditDetailedAnalysis);
    document.getElementById('save-detailed-analysis-btn').addEventListener('click', saveDetailedAnalysisEdits);
    document.getElementById('cancel-edit-detailed-analysis-btn').addEventListener('click', cancelEditDetailedAnalysis);
    document.getElementById('back-to-clinics-from-detailed-analysis').addEventListener('click', () => {
        toggleEditDetailedAnalysis(false); // 編集モードを強制解除
        showScreen('screen2');
    });
    // ▲▲▲ 詳細分析(Screen 5)用リスナー (追加) ▲▲▲
  }

  // --- 画面1 (変更なし) ---
  function populateDateSelectors() { const now=new Date();const cy=now.getFullYear();const sy=document.getElementById('start-year'),ey=document.getElementById('end-year');for(let i=0;i<5;i++){const y=cy-i;sy.add(new Option(`${y}年`,y));ey.add(new Option(`${y}年`,y));} const sm=document.getElementById('start-month'),em=document.getElementById('end-month');for(let i=1;i<=12;i++){const m=String(i).padStart(2,'0');sm.add(new Option(`${i}月`,m));em.add(new Option(`${i}月`,m));} em.value=String(now.getMonth()+1).padStart(2,'0');sm.value=String(now.getMonth()+1).padStart(2,'0'); }
  function handleNextToClinics() { console.log('Next clicked.');const sy=document.getElementById('start-year').value,sm=document.getElementById('start-month').value,ey=document.getElementById('end-year').value,em=document.getElementById('end-month').value;const sd=new Date(`${sy}-${sm}-01`),ed=new Date(`${ey}-${em}-01`);if(sd>ed){console.warn('Start>End.');alert('開始年月<=終了年月で設定');document.getElementById('start-year').classList.add('border-red-500');document.getElementById('start-month').classList.add('border-red-500');return;} document.getElementById('start-year').classList.remove('border-red-500');document.getElementById('start-month').classList.remove('border-red-500');selectedPeriod={start:`${sy}-${sm}`,end:`${ey}-${em}`};document.getElementById('period-display').textContent=`集計期間：${sy}年${sm}月～${ey}年${em}月`;console.log('Period:',selectedPeriod);showScreen('screen2');if(Object.keys(issuedReports).length===0){console.log('Loading clinics...');loadClinics();}else{console.log('Clinics already loaded.');} }

  // --- 画面2 (変更なし) ---
  async function loadClinics() { console.log('loadClinics...');showLoading(true,'クリニック一覧読込中...');const c=document.getElementById('clinic-list-container');c.innerHTML='<p class="text-sm text-gray-500 text-center py-4">読込中...</p>';try{console.log('Fetching list...');const r=await fetch('/api/getClinicList');console.log('Status:',r.status);if(!r.ok){const et=await r.text();console.error('Error:',r.status,et);throw new Error(`サーバーエラー(${r.status}): ${et}`);} const clinics=await r.json();console.log('Received:',clinics);c.innerHTML='';if(!Array.isArray(clinics)){console.error('Not array:',clinics);throw new Error('予期しないデータ形式');} if(clinics.length===0){console.log('None found.');c.innerHTML='<p class="text-sm text-gray-500 text-center py-4">対象なし</p>';}else{clinics.forEach(n=>{const d=document.createElement('div');d.className='flex items-center p-2 rounded-md hover:bg-gray-100';d.innerHTML=`<input type="checkbox" id="clinic-${n}" name="clinic" value="${n}" class="mr-3 h-4 w-4 rounded border-gray-300 text-gray-800 focus:ring-gray-800 cursor-pointer"><label for="clinic-${n}" class="text-sm select-none cursor-pointer">${n}</label>`;c.appendChild(d);});console.log('Populated.');c.removeEventListener('change',handleClinicCheckboxChange);c.addEventListener('change',handleClinicCheckboxChange);} showLoading(false);}catch(err){console.error('!!! Load failed:',err);c.innerHTML=`<p class="text-sm text-red-500 text-center py-4">読込失敗<br>${err.message}</p>`;showLoading(false);} }
  function handleClinicCheckboxChange() { const checked=document.querySelectorAll('#clinic-list-container input:checked').length;document.getElementById('issue-btn').disabled=checked===0; }
  async function handleIssueReport() { console.log('Issue report.');showLoading(true,'レポートデータ取得中...');const sc=Array.from(document.querySelectorAll('#clinic-list-container input:checked')).map(cb=>cb.value);console.log('Selected:',sc);try{console.log('Posting...');const r=await fetch('/api/getReportData',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({period:selectedPeriod,selectedClinics:sc})});console.log('Status:',r.status);if(!r.ok){const et=await r.text();console.error('Error:',r.status,et);throw new Error(`サーバーエラー(${r.status}): ${et}`);} const data=await r.json();console.log('Received data:',data);const ts=new Date().toLocaleString('ja-JP',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});let rg=false;Object.keys(data).forEach(cn=>{if(sc.includes(cn)){issuedReports[cn]={...data[cn],timestamp:ts};rg=true;console.log(`Stored for ${cn}`);}});if(rg){updateIssuedList();currentClinicForModal=sc[0];if(currentClinicForModal&&issuedReports[currentClinicForModal]){console.log(`Show modal for ${currentClinicForModal}`);showReportModal(true);}else{console.warn('Generated but no data for first selection:',currentClinicForModal);}}else{console.warn('Data received but empty/no match.');alert('データ取得失敗または対象なし');} showLoading(false);}catch(err){console.error('!!! Issue failed:',err);alert(`発行失敗\n${err.message}`);showLoading(false);} }
  function updateIssuedList() { const c=document.getElementById('issued-list-container');c.innerHTML='';const cn=Object.keys(issuedReports);if(cn.length===0){c.innerHTML='<p class="text-sm text-gray-500 text-center py-8">発行済レポートなし</p>';return;} cn.forEach(n=>{const d=document.createElement('div');d.className='p-4 border rounded-lg cursor-pointer hover:bg-gray-50 hover:shadow-md transition-all duration-200';d.dataset.clinicName=n;d.innerHTML=`<p class="font-bold text-base">${n}</p><p class="text-xs text-gray-500 mt-1">発行日時: ${issuedReports[n].timestamp}</p>`;c.appendChild(d);});console.log('Issued list updated.'); }

  // --- 画面3 & 4 (レポート/分析表示) ---
  function handleIssuedListClick(e){ const t=e.target.closest('[data-clinic-name]');if(t){currentClinicForModal=t.dataset.clinicName;if(issuedReports[currentClinicForModal]){showReportModal(true);}} }
  function handleReportModalClick(e){ const rt=e.target.dataset.reportType;if(rt){showReportModal(false);setTimeout(()=>prepareAndShowReport(rt),300);} }
  
  // ▼▼▼ handleReportNavClick (変更あり) ▼▼▼
  function handleReportNavClick(e) {
    const targetButton = e.target.closest('.btn');
    if (!targetButton) return;

    const reportType = targetButton.dataset.reportType;
    const analysisType = targetButton.dataset.analysisType;
    const detailedAnalysisType = targetButton.dataset.detailedAnalysisType; // ★ 詳細分析タイプを取得

    if (reportType) {
        console.log(`Report nav: ${reportType}`);
        // ★ 市区町村レポートと、新しい2つのレポートの分岐を追加
        if (reportType === 'municipality') {
            prepareAndShowMunicipalityReport();
        } else if (reportType === 'recommendation') {
            // ★ 新規追加
            prepareAndShowRecommendationReport();
        } else if (reportType === 'nps_score') {
            // ★ 新規追加
            prepareAndShowReport(reportType); // 既存のロジックを流用
        } else {
            prepareAndShowReport(reportType);
        }
    } else if (analysisType) {
        console.log(`Analysis nav: ${analysisType}`);
        currentAnalysisTarget = analysisType;
        prepareAndShowAnalysis(analysisType);
    } else if (detailedAnalysisType) { // ★ 詳細分析の分岐を追加
        console.log(`Detailed Analysis nav: ${detailedAnalysisType}`);
        currentDetailedAnalysisType = detailedAnalysisType;
        prepareAndShowDetailedAnalysis(detailedAnalysisType);
    }
  }
  // ▲▲▲ handleReportNavClick (変更あり) ▲▲▲

  // ▼▼▼ prepareAndShowReport (変更あり) ▼▼▼
  // (municipality の分岐を削除し、nps_score の分岐を追加)
  function prepareAndShowReport(reportType){
    console.log(`Prepare report: ${reportType}`); 
    showLoading(true,'レポート準備中...');
    updateNavActiveState(reportType, null, null); 
    const cd=issuedReports[currentClinicForModal];
    if(!cd){showLoading(false);return;} 
    slidesData=[];
    document.getElementById('pagination').style.display='flex';
    document.getElementById('slide-body').style.whiteSpace='pre-wrap';
    document.getElementById('slide-header').innerHTML='';
    document.getElementById('slide-body').innerHTML='';
    let isChart=false,isBar=false; 
    
    // ★★★ 新しいグラフ (nps_score) の分岐を追加 ★★★
    if (reportType === 'nps_score'){
        prepareChartShell(
            'NPS(ネットプロモータースコア)＝推奨度',
            'これから初めてお産を迎える友人知人がいた場合、\nご出産された産婦人科医院をどのくらいお勧めしたいですか。\n友人知人への推奨度を教えてください。＜推奨度＞ 10:強くお勧めする〜 0:全くお勧めしない',
            true // 棒グラフ(isBar = true)
        );
        isChart=true;isBar=true;
    }
    else if (reportType === 'nps'){const{totalCount,results}=cd.npsData;prepareNpsSlides(results,`NPS理由(全${totalCount}件)`);}
    else if (reportType === 'feedback_i'){prepareCommentSlides(cd.feedbackData.i_column,'良かった点悪かった点');}
    else if (reportType === 'feedback_j'){prepareCommentSlides(cd.feedbackData.j_column,'印象に残ったスタッフ');}
    else if (reportType === 'feedback_m'){prepareCommentSlides(cd.feedbackData.m_column,'お産意見感想');}
    else if (reportType === 'satisfaction_b'){prepareChartShell('満足度','5段階評価');isChart=true;}
    else if (reportType === 'satisfaction_c'){prepareChartShell('施設','5段階評価');isChart=true;}
    else if (reportType === 'satisfaction_d'){prepareChartShell('アクセス','5段階評価');isChart=true;}
    else if (reportType === 'satisfaction_e'){prepareChartShell('価格','5段階評価');isChart=true;}
    else if (reportType === 'satisfaction_f'){prepareChartShell('雰囲気','5段階評価');isChart=true;}
    else if (reportType === 'satisfaction_g'){prepareChartShell('スタッフ対応','5段階評価');isChart=true;}
    else if (reportType === 'satisfaction_h'){prepareChartShell('先生説明','5段階評価');isChart=true;}
    else if (reportType === 'age'){prepareChartShell('年代','');isChart=true;}
    else if (reportType === 'children'){prepareChartShell('お子様数','1人, 2人, 3人, 4人, 5人以上');isChart=true;}
    else if (reportType === 'income'){prepareChartShell('世帯年収','',true);isChart=true;isBar=true;}
    
    if(slidesData.length>0){currentPage=1;renderSlide(currentPage);}
    // =================================================================
    // === ▼▼▼ ここが修正箇所です ▼▼▼ ===
    // =================================================================
    // 'nps_score' が 'nps' に前方一致しないよう、'reportType === 'nps'' で完全一致に変更
    else if(slidesData.length===0&& (reportType === 'nps' || reportType.startsWith('feedback')) ){
    // =================================================================
    // === ▲▲▲ 修正はここまでです ▲▲▲ ===
    // =================================================================
        document.getElementById('slide-header').innerHTML='';
        document.getElementById('slide-body').innerHTML='<p class="text-center text-gray-500">該当データなし</p>';
        document.getElementById('pagination').style.display='none';
    } 
    
    showScreen('screen3'); 
    
    if(isChart){
        setTimeout(()=>{
            try{
                let data;
                
                // =================================================================
                // === ▼▼▼ ログ追加: 描画関数呼び出し直前の #slide-body 確認 ▼▼▼ ===
                // =================================================================
                console.log('[DEBUG] Before calling draw function, slide-body innerHTML:', document.getElementById('slide-body').innerHTML);
                // =================================================================
                // === ▲▲▲ ログ追加 ▲▲▲ ===
                // =================================================================

                // ★★★ nps_score グラフ描画関数の呼び出しを追加 ★★★
                if(reportType==='nps_score'){
                    
                    data=cd.npsScoreData;
                    
                    // =================================================================
                    // === ▼▼▼ 修正点 1: 描画エラー防止 ▼▼▼ ===
                    // =================================================================
                    // サーバーから npsScoreData が返ってこない (undefined) 場合にエラーをスローし、catchブロックで表示
                    if (!data) {
                        console.error("[FIX] npsScoreData is missing. Server might be running old code.");
                        throw new Error('NPSスコアデータ (npsScoreData) が見つかりません。');
                    }
                    // =================================================================
                    // === ▲▲▲ 修正点 1: 描画エラー防止 ▲▲▲ ===
                    // =================================================================

                    drawNpsScoreCharts(data); // ★ 新規関数
                }
                else if(reportType.startsWith('satisfaction')){data=cd.satisfactionData[reportType.split('_')[1]+'_column'];drawSatisfactionCharts(data.results);}
                else if(reportType==='age'){data=cd.ageData;drawSatisfactionCharts(data.results);}
                else if(reportType==='children'){data=cd.childrenCountData;drawSatisfactionCharts(data.results);}
                else if(reportType==='income'){data=cd.incomeData;drawIncomeCharts(data);}
            }catch(e){
                console.error('Chart draw error:',e);
                // グラフ描画失敗の理由を(e.message)で表示
                document.getElementById('slide-body').innerHTML=`<p class="text-center text-red-500">グラフ描画失敗<br>(${e.message})</p>`;
            }finally{
                showLoading(false);
            }
        },100);
    } else {
        showLoading(false);
    } 
  }
  // ▲▲▲ prepareAndShowReport (変更あり) ▲▲▲

  function prepareNpsSlides(results, title){ document.getElementById('report-title').textContent=title;document.getElementById('report-subtitle').textContent='';const ml=20;if(!results)return;const sc=Object.keys(results).map(Number).sort((a,b)=>b-a);sc.forEach(s=>{const rs=results[s];if(!rs||rs.length===0)return;let clc=0,cpb='';rs.forEach((r,i)=>{const rt=`・ ${r}`;const rl=(rt.match(/\n/g)||[]).length+1;if(clc>0&&(clc+rl)>ml){slidesData.push({header:`推奨度 ${s}(${rs.length}人)`,body:cpb});cpb=rt;clc=rl;}else{cpb+=(clc===0?'':'\n')+rt;clc+=rl;}});if(cpb){slidesData.push({header:`推奨度 ${s}(${rs.length}人)`,body:cpb});}}); }
  function prepareCommentSlides(data, title){ if(!data)data={totalCount:0,results:[]};const{totalCount,results}=data;document.getElementById('report-title').textContent=`${title}(全${totalCount}件)`;document.getElementById('report-subtitle').textContent='';const ml=20;if(results&&results.length>0){let clc=0,cpb='';results.forEach((it,i)=>{const itx=`・ ${it}`;const il=(itx.match(/\n/g)||[]).length+1;if(clc>0&&(clc+il)>ml){slidesData.push({header:'',body:cpb});cpb=itx;clc=il;}else{cpb+=(clc===0?'':'\n')+itx;clc+=il;}});if(cpb){slidesData.push({header:'',body:cpb});}} }
  // =================================================================
  // === ▼▼▼ ログ追加: prepareChartShell 実行確認 ▼▼▼ ===
  // =================================================================
  function prepareChartShell(title, subtitle, isBar=false){ 
    console.log(`[DEBUG] prepareChartShell called for title: "${title}", isBar: ${isBar}`); // 実行確認ログ
    document.getElementById('report-title').textContent=`アンケート結果 ー${title}ー`;
    document.getElementById('report-subtitle').textContent=subtitle;
    document.getElementById('pagination').style.display='none';
    document.getElementById('slide-body').style.whiteSpace='normal';
    const cid=isBar?'bar-chart':'pie-chart',hc=isBar?'h-[350px]':'h-[400px]';
    const htmlContent = `<div class="grid grid-cols-1 md:grid-cols-2 gap-8"><div class="flex flex-col items-center"><h3 class="font-bold text-lg mb-4 text-center">貴院の結果</h3><div id="clinic-${cid}" class="w-full ${hc}"></div></div><div class="flex flex-col items-center"><h3 class="font-bold text-lg mb-4 text-center">（参照）全体平均</h3><div id="average-${cid}" class="w-full ${hc}"></div></div></div>`;
    document.getElementById('slide-body').innerHTML = htmlContent; 
    console.log(`[DEBUG] prepareChartShell finished setting innerHTML for #slide-body. Content includes clinic-${cid}?`, htmlContent.includes(`id="clinic-${cid}"`)); // HTML書き込み後ログ
  }
  // =================================================================
  // === ▲▲▲ ログ追加 ▲▲▲ ===
  // =================================================================
  function renderSlide(page){ if(page<1||page>slidesData.length)return;const s=slidesData[page-1];document.getElementById('slide-header').innerHTML=s.header;document.getElementById('slide-body').innerHTML=s.body;document.getElementById('page-indicator').textContent=`${page} / ${slidesData.length}`;document.getElementById('prev-slide').disabled=(page===1);document.getElementById('next-slide').disabled=(page===slidesData.length); }
  
  // =================================================================
  // === ここが修正箇所です (フォントサイズ 17) ===
  // =================================================================
  function drawSatisfactionCharts(chartData){ const opt={
    is3D:true,
    chartArea:{left:'5%',top:'5%',width:'90%',height:'90%'},
    pieSliceText:'percentage',
    
    // ★ パーセンテージのフォントサイズを 17 に変更
    pieSliceTextStyle:{color:'black',fontSize:17,bold:true},
    
    // ★ 項目名(凡例)のフォントサイズを 17 に変更
    legend:{position:'labeled',textStyle:{color:'black',fontSize:17}},
    
    tooltip:{showColorCode:true,textStyle:{fontSize:14},trigger:'focus'},
    colors:['#4285F4','#DB4437','#F4B400','#0F9D58','#990099']};
    
    const cdEl=document.getElementById('clinic-pie-chart');
    // ★ 要素存在チェックを追加
    if (!cdEl) {
        console.error('[FIX-satisfaction] Cannot find element with ID: clinic-pie-chart');
        throw new Error('グラフ描画エリア(clinic-pie-chart)が見つかりません。');
    }
    if(chartData&&chartData.length>1&&chartData.slice(1).some(row=>row[1]>0)){
        const d=google.visualization.arrayToDataTable(chartData);
        const c=new google.visualization.PieChart(cdEl);
        c.draw(d,opt);
    } else {
        cdEl.innerHTML='<div class="flex items-center justify-center h-full"><p class="text-gray-500">データなし</p></div>';
    } 
    const avgEl=document.getElementById('average-pie-chart');
    // ★ 要素存在チェックを追加
    if (!avgEl) {
        console.error('[FIX-satisfaction] Cannot find element with ID: average-pie-chart');
        throw new Error('グラフ描画エリア(average-pie-chart)が見つかりません。');
    }
    const avgD=google.visualization.arrayToDataTable([['満足度','割合'],['非常に満足',73.5],['満足',24.2],['ふつう',2.0],['不満',0.3],['非常に不満',0]]);
    const avgC=new google.visualization.PieChart(avgEl);
    avgC.draw(avgD,opt); // ★ 平均グラフにも同じオプション(opt)を適用
  }
  // =================================================================
  // === 修正箇所はここまでです ===
  // =================================================================

  // =================================================================
  // === ▼▼▼ 修正点 3: 世帯年収Y軸バグ修正 & 要素チェック追加▼▼▼ ===
  // =================================================================
  function drawIncomeCharts({results,totalCount}){ 
    const opt={
        legend:{position:'none'},
        colors:['#DE5D83'],
        annotations:{textStyle:{fontSize:12,color:'black',auraColor:'none'},alwaysOutside:false,stem:{color:'transparent'}},
        // ★ Y軸のフォーマットを修正: 
        // 1000% と表示されていたバグを修正。
        // `#.##'%'` は、渡された数値 (例: 15) にそのまま '%' を付けます (例: 15%)
        vAxis:{format:"#.##'%'",viewWindow:{min:0}}, 
        hAxis:{}
    };
    const ccdEl=document.getElementById('clinic-bar-chart');
    // ★ 要素存在チェックを追加
    if (!ccdEl) {
        console.error('[FIX-income] Cannot find element with ID: clinic-bar-chart');
        throw new Error('グラフ描画エリア(clinic-bar-chart)が見つかりません。');
    }
    if(totalCount>0&&results&&results.length>1){
        const cd=google.visualization.arrayToDataTable(results);
        const cc=new google.visualization.ColumnChart(ccdEl);
        cc.draw(cd,opt);
    } else {
        ccdEl.innerHTML='<div class="flex items-center justify-center h-full"><p class="text-gray-500">データなし</p></div>';
    } 
    const avgEl=document.getElementById('average-bar-chart');
     // ★ 要素存在チェックを追加
    if (!avgEl) {
        console.error('[FIX-income] Cannot find element with ID: average-bar-chart');
        throw new Error('グラフ描画エリア(average-bar-chart)が見つかりません。');
    }
    const avgD=google.visualization.arrayToDataTable([['評価','割合',{role:'annotation'}],['1',1,'1%'],['2',2,'2%'],['3',7,'7%'],['4',12,'12%'],['5',16,'16%'],['6',16,'16%'],['7',13,'13%'],['8',12,'12%'],['9',8,'8%'],['10',15,'15%']]);
    const avgC=new google.visualization.ColumnChart(avgEl);
    avgC.draw(avgD,opt); 
  }
  // =================================================================
  // === ▲▲▲ 修正点 3 & 要素チェック ▲▲▲ ===
  // =================================================================

  function handlePrevSlide(){ if(currentPage>1){currentPage--;renderSlide(currentPage);} }
  function handleNextSlide(){ if(currentPage<slidesData.length){currentPage++;renderSlide(currentPage);} }

  // --- テキスト分析関連 (ワードクラウド修正済み) ---
  async function prepareAndShowAnalysis(columnType) { showLoading(true,`テキスト分析中(${getColumnName(columnType)})...`);showScreen('screen4');document.getElementById('analysis-error').classList.add('hidden');clearAnalysisCharts();updateNavActiveState(null, columnType, null); const cd=issuedReports[currentClinicForModal];if(!cd){console.error("No report data for analysis.");showLoading(false);return;} let tl=[],td=0;try{switch(columnType){case'L':tl=cd.npsData.rawText||[];td=cd.npsData.totalCount||0;break;case'I':tl=cd.feedbackData.i_column.results||[];td=cd.feedbackData.i_column.totalCount||0;break;case'J':tl=cd.feedbackData.j_column.results||[];td=cd.feedbackData.j_column.totalCount||0;break;case'M':tl=cd.feedbackData.m_column.results||[];td=cd.feedbackData.m_column.totalCount||0;break;default:console.error("Invalid column:",columnType);showLoading(false);return;}}catch(e){console.error("Error accessing text data:",e,"Data:",cd);alert("レポートデータアクセスエラー");showLoading(false);return;} document.getElementById('analysis-title').textContent=getAnalysisTitle(columnType,td);if(tl.length===0){console.log("No text to analyze:",columnType);document.getElementById('analysis-error').textContent='分析対象テキストなし';document.getElementById('analysis-error').classList.remove('hidden');showLoading(false);return;} try{console.log(`Sending ${tl.length} texts`);const r=await fetch('/api/analyzeText',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({textList:tl})});if(!r.ok){const et=await r.text();console.error(`Analyze API error(${r.status}):`,et);throw new Error(`分析APIエラー(${r.status}): ${et}`);} const ad=await r.json();console.log("Received analysis:",ad);drawAnalysisCharts(ad.results);}catch(error){console.error('!!! Analyze fail:',error);document.getElementById('analysis-error').textContent=`分析失敗: ${error.message}`;document.getElementById('analysis-error').classList.remove('hidden');}finally{showLoading(false);}}
  function drawAnalysisCharts(results) { if(!results||results.length===0){console.log("No analysis results.");document.getElementById('analysis-error').textContent='分析結果なし';document.getElementById('analysis-error').classList.remove('hidden');return;} const nouns=results.filter(r=>r.pos==='名詞'),verbs=results.filter(r=>r.pos==='動詞'),adjs=results.filter(r=>r.pos==='形容詞'),ints=results.filter(r=>r.pos==='感動詞');const barOpt={bars:'horizontal',legend:{position:'none'},hAxis:{title:'スコア(出現頻度)',minValue:0},vAxis:{title:'単語'},height:500,width:'100%'};drawSingleBarChart(nouns.slice(0,20),'noun-chart',{...barOpt,colors:['#3b82f6']});drawSingleBarChart(verbs.slice(0,20),'verb-chart',{...barOpt,colors:['#ef4444']});drawSingleBarChart(adjs.slice(0,20),'adj-chart',{...barOpt,colors:['#22c55e']});drawSingleBarChart(ints.slice(0,20),'int-chart',{...barOpt,colors:['#6b7280']});const wl=results.map(r=>[r.word,r.score]).slice(0,100);const pm=results.reduce((map,item)=>{map[item.word]=item.pos;return map;},{});console.log('WordCloud List:',wl);const cv=document.getElementById('word-cloud-canvas');if(WordCloud.isSupported&&cv){try{const options={list:wl,gridSize:Math.round(16*cv.width/1024),weightFactor:function(s){return Math.pow(s,0.8)*cv.width/250;},fontFamily:'Noto Sans JP,sans-serif',color:function(w,wt,fs,d,t){const p=pm[w]||'不明';switch(p){case'名詞':return'#3b82f6';case'動詞':return'#ef4444';case'形容詞':return'#22c55e';case'感動詞':return'#6b7280';default:return'#a8a29e';}},backgroundColor:'#f9fafb',clearCanvas:true};console.log('WordCloud Options:',options);WordCloud(cv,options);console.log("Word cloud drawn.");}catch(wcError){console.error("Error drawing WordCloud:",wcError);document.getElementById('word-cloud-container').innerHTML=`<p class="text-center text-red-500">ワードクラウド描画エラー:${wcError.message}</p>`;}}else{console.warn("WordCloud unsupported/canvas missing.");document.getElementById('word-cloud-container').innerHTML='<p class="text-center text-gray-500">ワードクラウド非対応</p>';} }
  function drawSingleBarChart(data, elementId, options) { const c=document.getElementById(elementId);if(!c){console.error(`Element not found: ${elementId}`);return;} if(!data||data.length===0){c.innerHTML='<p class="text-center text-gray-500 text-sm py-4">データなし</p>';return;} const cd=[['単語','スコア',{role:'style'}]];const color=options.colors&&options.colors.length>0?options.colors[0]:'#a8a29e';data.slice().reverse().forEach(item=>{cd.push([item.word,item.score,color]);});try{const dt=google.visualization.arrayToDataTable(cd);const chart=new google.visualization.BarChart(c);chart.draw(dt,options);}catch(chartError){console.error(`Error drawing bar chart for ${elementId}:`,chartError);c.innerHTML=`<p class="text-center text-red-500 text-sm py-4">グラフ描画エラー<br>${chartError.message}</p>`;} }
  function clearAnalysisCharts() { document.getElementById('noun-chart').innerHTML='';document.getElementById('verb-chart').innerHTML='';document.getElementById('adj-chart').innerHTML='';document.getElementById('int-chart').innerHTML='';const c=document.getElementById('word-cloud-canvas');const x=c.getContext('2d');x.clearRect(0,0,c.width,c.height);document.getElementById('analysis-error').classList.add('hidden');document.getElementById('analysis-error').textContent=''; }
  function getAnalysisTitle(columnType, count) { const bt=`アンケート結果　ー${getColumnName(columnType)}ー`;return`${bt}　※全回答数${count}件ー`; }
  function getColumnName(columnType) { switch(columnType){case'L':return'NPS推奨度 理由';case'I':return'良かった点や悪かった点など';case'J':return'印象に残ったスタッフへのコメント';case'M':return'お産にかかわるご意見・ご感想';default:return'不明';} }


  // --- ★ 市区町村レポート関数 (変更なし) ---
  async function prepareAndShowMunicipalityReport() {
    console.log('Prepare municipality report');
    const clinicName = currentClinicForModal;
    const cd = issuedReports[clinicName];
    
    if (!cd || !cd.postalCodeData || !cd.postalCodeData.counts) {
        alert('郵便番号データ(postalCodeData)がレポートデータに見つかりません。');
        return;
    }

    showLoading(true, '市区町村データを集計中...');
    showScreen('screen3');
    updateNavActiveState('municipality', null, null);
    
    // --- レポートの静的タイトルなどを設定 ---
    document.getElementById('report-title').textContent = `${clinicName} - 市区町村別 集計`;
    document.getElementById('report-subtitle').textContent = 'アンケート回答者の郵便番号(R列)を元に集計';
    document.getElementById('pagination').style.display = 'none'; // ページネーション不要
    document.getElementById('slide-header').innerHTML = ''; // ヘッダー不要
    const slideBody = document.getElementById('slide-body');
    slideBody.style.whiteSpace = 'normal'; // pre-wrap解除
    slideBody.innerHTML = '<p class="text-center text-gray-500">外部APIから住所データを取得・集計中...</p>'; // 待機メッセージ
    
    try {
        // 1. クライアント側キャッシュ(issuedReports)を確認
        if (cd.municipalityReportTable) {
            console.log('Using cached municipality report from issuedReports');
            displayMunicipalityTable(cd.municipalityReportTable);
            showLoading(false);
            return;
        }
        console.log(`Calling API /api/generateMunicipalityReport for ${clinicName}`);
        
        // 2. サーバーAPIを呼び出し
        const response = await fetch('/api/generateMunicipalityReport', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                postalCodeCounts: cd.postalCodeData.counts,
                clinicName: clinicName
            })
        });
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`集計APIエラー (${response.status}): ${errorText}`);
        }
        const tableData = await response.json();
        
        // 3. クライアント側キャッシュに保存
        cd.municipalityReportTable = tableData;
        // 4. テーブル描画
        displayMunicipalityTable(tableData);
    } catch (err) {
        console.error('Failed to get municipality report:', err);
        slideBody.innerHTML = `<p class="text-center text-red-500">集計失敗: ${err.message}</p>`;
    } finally {
        showLoading(false);
    }
  }
  function displayMunicipalityTable(data) {
    const slideBody = document.getElementById('slide-body');
    if (!data || data.length === 0) {
        slideBody.innerHTML = '<p class="text-center text-gray-500">集計データがありません。</p>';
        return;
    }
    let tableHtml = `
        <div class="overflow-x-auto overflow-y-auto max-h-[600px] border border-gray-200 rounded-lg">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50 sticky top-0 z-10">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">A列: 都道府県</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">B列: 市区町村</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">C列: 件数</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">D列: 割合</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
    `;
    data.forEach(row => {
        tableHtml += `
            <tr>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${row.prefecture}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${row.municipality}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 text-right">${row.count}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 text-right">${row.percentage.toFixed(2)}%</td>
            </tr>
        `;
    });
    tableHtml += '</tbody></table></div>';
    slideBody.innerHTML = tableHtml;
  }
  // --- ▲▲▲ 市区町村レポート関数 (変更なし) ---


  // =================================================================
  // === ▼▼▼ ここから新規関数 (NPSスコアグラフ, おすすめ理由グラフ) ▼▼▼ ===
  // =================================================================

  /**
   * NPSスコアグラフ(K列)の描画
   */
  function drawNpsScoreCharts(data) {
      // data が undefined の場合は prepareAndShowReport で throw される
      const { counts, totalCount } = data;
      
      // =================================================================
      // === ▼▼▼ Container is not defined エラー対策 ▼▼▼ ===
      // =================================================================
      // グラフを描画する要素が存在するか確認
      const clinicChartEl = document.getElementById('clinic-bar-chart');
      const averageChartEl = document.getElementById('average-bar-chart');

      if (!clinicChartEl) { // averageChartEl はなくても致命的ではない
          console.error('[FIX-NPS] Cannot find element with ID: clinic-bar-chart');
          throw new Error('グラフ描画エリア(clinic-bar-chart)が見つかりません。');
      }
       if (!averageChartEl) {
          console.error('[FIX-NPS] Cannot find element with ID: average-bar-chart');
          throw new Error('グラフ描画エリア(average-bar-chart)が見つかりません。');
      }
      // =================================================================
      // === ▲▲▲ Container is not defined エラー対策 ▲▲▲ ===
      // =================================================================

      // 1. NPSスコア計算 (0-10の全データで計算)
      let promoters = 0; // 9-10
      let passives = 0; // 7-8
      let detractors = 0; // 0-6
      
      for (let i = 0; i <= 10; i++) {
          if (counts[i] === undefined) continue;
          
          if (i >= 9) {
              promoters += counts[i];
          } else if (i >= 7) {
              passives += counts[i];
          } else {
              detractors += counts[i];
          }
      }
      
      let npsScore = 0;
      if (totalCount > 0) {
          npsScore = ((promoters / totalCount) - (detractors / totalCount)) * 100;
      }
      
      // =================================================================
      // === ▼▼▼ 修正点 2: NPS X軸 (1-10) ▼▼▼ ===
      // =================================================================
      
      // 2. 貴院のグラフデータ作成 (1-10のみ)
      const clinicChartData = [['スコア', '割合', { role: 'annotation' }]];
      if (totalCount > 0) {
          // ★ ループを 0 からではなく 1 から開始
          for (let i = 1; i <= 10; i++) {
              const count = counts[i] || 0;
              const percentage = (count / totalCount) * 100;
              clinicChartData.push([String(i), percentage, `${Math.round(percentage)}%`]);
          }
      }
      
      // 3. 全体平均のグラフデータ (1-10のみ)
      const averageChartData = google.visualization.arrayToDataTable([
          ['スコア', '割合', { role: 'annotation' }],
          // ★ '0' の行を削除
          ['1', 0, '0%'], ['2', 0, '0%'], ['3', 1, '1%'],
          ['4', 1, '1%'], ['5', 3, '3%'], ['6', 4, '4%'], ['7', 12, '12%'],
          ['8', 28, '28%'], ['9', 20, '20%'], ['10', 30, '30%']
      ]);
      // ★ 平均NPSスコアは「0」を含めて計算 (ハードコード値は変更なし)
      const overallNPS = 41.8; // ( (20+30) - (1+0+0+1+1+3+4) )

      // 4. グラフオプション
      const opt = {
          legend: { position: 'none' },
          colors: ['#4285F4'], // 棒グラフの色
          annotations: {
              textStyle: { fontSize: 12, color: 'black', auraColor: 'none' },
              alwaysOutside: false,
              stem: { color: 'transparent' }
          },
          // =================================================================
          // === ▼▼▼ 修正点 3: NPS Y軸バグ修正 ▼▼▼ ===
          // =================================================================
          vAxis: { 
              // ★ Y軸のフォーマットを修正 (1000% バグ修正)
              format: "#.##'%'", // 渡された数値 (例: 15) に '%' を付けます (例: 15%)
              title: '割合(%)',
              viewWindow: { min: 0 } 
          },
          // =================================================================
          // === ▲▲▲ 修正点 3: NPS Y軸バグ修正 ▲▲▲ ===
          // =================================================================
          hAxis: {
              title: '推奨度スコア (1〜10)' // ★ ラベルを 1-10 に変更
          },
          bar: { groupWidth: '80%' },
          isStacked: false
      };
      
      // 5. 貴院のグラフ描画
      // const clinicChartEl = document.getElementById('clinic-bar-chart'); // 上で取得済み
      if (totalCount > 0 && clinicChartData.length > 1) {
          const clinicData = google.visualization.arrayToDataTable(clinicChartData);
          const clinicChart = new google.visualization.ColumnChart(clinicChartEl);
          clinicChart.draw(clinicData, opt);
      } else {
          // clinicChartData.length <= 1 は「データなし」と同じ
          clinicChartEl.innerHTML = '<div class="flex items-center justify-center h-full"><p class="text-gray-500">データなし</p></div>';
      }

      // 6. 全体平均のグラフ描画とNPSスコア表示
      // const averageChartEl = document.getElementById('average-bar-chart'); // 上で取得済み
      // 既存のグラフ描画
      const averageChart = new google.visualization.ColumnChart(averageChartEl);
      averageChart.draw(averageChartData, opt);
      
      // =================================================================
      // === ▼▼▼ 修正点 4: NPSスコア表示 フォントサイズ調整 ▼▼▼ ===
      // =================================================================
      // グラフの上にある <H3> タグ (average-bar-chart の親の親のH3) を見つけて書き換える
      const averageHeaderEl = averageChartEl.parentElement.querySelector('h3');
      if (averageHeaderEl) {
          averageHeaderEl.innerHTML = `
              // ★ 外側の div のクラスを text-2xl に変更
              <div class="text-left text-2xl space-y-2">
                  <p>全体平均　　NPS: ${overallNPS.toFixed(1)}</p>
                  // ★ span の text-2xl は削除 (親に指定するため)
                  <p>貴院　　NPS: <span class="font-bold text-red-600">${npsScore.toFixed(1)}</span></p>
              </div>
          `;
          // ★ クラス名を text-2xl に変更
          averageHeaderEl.className = "font-normal text-2xl mb-4 text-left"; // text-center を解除
      }
      // =================================================================
      // === ▲▲▲ 修正点 4 ▲▲▲ ===
      // =================================================================
      
      // 「貴院の結果」のH3も調整
      const clinicHeaderEl = clinicChartEl.parentElement.querySelector('h3');
      if (clinicHeaderEl) {
           clinicHeaderEl.className = "font-bold text-xl mb-4 text-left"; // text-center を解除
           // totalCount (全件数) には 0 の票も含まれるため、この表記で正しい
           clinicHeaderEl.textContent = `貴院の結果 (全 ${totalCount} 件)`;
      }
  }
  // =================================================================
  // === ▲▲▲ 修正点 2: NPS X軸 (1-10) ▲▲▲ ===
  // =================================================================


  /**
   * おすすめ理由グラフ(N列)の準備と表示 (AI分類実行)
   */
  async function prepareAndShowRecommendationReport() {
      console.log('Prepare recommendation report');
      const clinicName = currentClinicForModal;
      const cd = issuedReports[clinicName];
      
      if (!cd || !cd.recommendationData) {
          alert('おすすめ理由データ(recommendationData)が見つかりません。');
          return;
      }

      showLoading(true, '「その他」項目をAIで分類中...');
      showScreen('screen3');
      updateNavActiveState('recommendation', null, null);

      // --- レポートの静的タイトルなどを設定 ---
      document.getElementById('report-title').textContent = 'アンケート結果　ー本病院を選ぶ上で最も参考にしたものー';
      document.getElementById('report-subtitle').textContent = 'ご出産された産婦人科医院への本病院を選ぶ上で最も参考にしたものについて、教えてください\n＜5段階評価＞ 5:非常に満足〜 1:非常に不満';
      document.getElementById('pagination').style.display = 'none';
      document.getElementById('slide-header').innerHTML = '';
      const slideBody = document.getElementById('slide-body');
      slideBody.style.whiteSpace = 'normal';
      // グラフ描画エリア(満足度グラフと共通)
      slideBody.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-8"><div class="flex flex-col items-center"><h3 class="font-bold text-lg mb-4 text-center">貴院の結果</h3><div id="clinic-pie-chart" class="w-full h-[400px]"></div></div><div class="flex flex-col items-center"><h3 class="font-bold text-lg mb-4 text-center">（参照）全体平均</h3><div id="average-pie-chart" class="w-full h-[400px]"></div></div></div>`;

      try {
          const { fixedCounts, otherList, fixedKeys } = cd.recommendationData;
          
          // 1. 「その他」の分類結果をキャッシュまたはAPIから取得
          let finalCounts = { ...fixedCounts }; // 固定キーのカウントをコピー
          finalCounts['その他'] = 0; // 「その他」バケツを初期化
          
          // 2. クライアント側キャッシュ(issuedReports)を確認 (分類済みデータ)
          if (cd.recommendationData.classifiedData) {
              console.log('Using cached AI classification from issuedReports');
              finalCounts = cd.recommendationData.classifiedData;
          }
          // 3. AI分類が必要な場合
          else if (otherList && otherList.length > 0) {
              console.log(`Calling API /api/classifyRecommendations for ${clinicName}`);
              const response = await fetch('/api/classifyRecommendations', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                      clinicName: clinicName,
                      otherList: otherList,
                      fixedKeys: fixedKeys
                  })
              });
              if (!response.ok) {
                  const errorText = await response.text();
                  throw new Error(`AI分類APIエラー (${response.status}): ${errorText}`);
              }
              
              const classificationResult = await response.json(); // { classifiedResults: [...] }
              
              // 4. AI分類結果を集計
              classificationResult.classifiedResults.forEach(item => {
                  item.matchedCategories.forEach(category => {
                      if (finalCounts[category] !== undefined) {
                          finalCounts[category]++;
                      } else {
                          // 予期しないカテゴリが返ってきた場合 (通常は "その他" になるはず)
                          finalCounts['その他']++;
                      }
                  });
              });
              
              // 5. クライアントキャッシュに保存
              cd.recommendationData.classifiedData = finalCounts;
              
          } else {
              console.log("No 'other' items to classify.");
          }

          showLoading(false); // AI分類が終わった時点でローディング解除

          // 6. グラフ描画
          
          // 貴院のグラフデータ
          const allKeys = [...fixedKeys, 'その他'];
          const clinicChartData = [['カテゴリ', '件数']];
          allKeys.forEach(key => {
              clinicChartData.push([key, finalCounts[key] || 0]);
          });
          
          // 全体平均のグラフデータ (ハードコード)
           const averageChartData = google.visualization.arrayToDataTable([
              ['カテゴリ', '件数'],
              ['インターネット（Googleの口コミ）', 25],
              ['インターネット（SNS）', 15],
              ['インターネット（産院のホームページ）', 20],
              ['知人の紹介', 18],
              ['家族の紹介', 10],
              ['自宅からの距離', 10],
              ['インターネット（情報サイト）', 5],
              ['その他', 2]
          ]);

          // 円グラフオプション (フォントサイズ 17)
          const opt = {
              is3D: true,
              chartArea: { left: '5%', top: '5%', width: '90%', height: '90%' },
              pieSliceText: 'percentage',
              pieSliceTextStyle: { color: 'black', fontSize: 17, bold: true },
              legend: { position: 'labeled', textStyle: { color: 'black', fontSize: 17 } },
              tooltip: { showColorCode: true, textStyle: { fontSize: 14 }, trigger: 'focus' },
              // colors: [...] // 色はGoogle Chartsのデフォルトに任せる
          };

          // 貴院のグラフ描画
          const clinicChartEl = document.getElementById('clinic-pie-chart');
           // ★★★ 要素存在チェックを追加 ★★★
          if (!clinicChartEl) {
                console.error('[FIX-recommendation] Cannot find element with ID: clinic-pie-chart');
                throw new Error('グラフ描画エリア(clinic-pie-chart)が見つかりません。');
          }
          const totalClinicCount = clinicChartData.slice(1).reduce((sum, row) => sum + row[1], 0);
          if (totalClinicCount > 0) {
              const d = google.visualization.arrayToDataTable(clinicChartData);
              const c = new google.visualization.PieChart(clinicChartEl);
              c.draw(d, opt);
          } else {
              clinicChartEl.innerHTML = '<div class="flex items-center justify-center h-full"><p class="text-gray-500">データなし</p></div>';
          }
          
          // 全体平均のグラフ描画
          const averageChartEl = document.getElementById('average-pie-chart');
           // ★★★ 要素存在チェックを追加 ★★★
          if (!averageChartEl) {
                console.error('[FIX-recommendation] Cannot find element with ID: average-pie-chart');
                throw new Error('グラフ描画エリア(average-pie-chart)が見つかりません。');
          }
          const avgC = new google.visualization.PieChart(averageChartEl);
          avgC.draw(averageChartData, opt);

      } catch (err) {
          console.error('Failed to get recommendation report:', err);
          slideBody.innerHTML = `<p class="text-center text-red-500">集計失敗: ${err.message}</p>`;
          showLoading(false);
      }
  }

  // =================================================================
  // === ▲▲▲ 新規関数はここまで ▲▲▲ ===
  // =================================================================


  // --- ▼▼▼ 詳細分析関連 (JS関数追加) ▼▼▼

  /**
   * 詳細分析(AI)の準備と表示
   */
  async function prepareAndShowDetailedAnalysis(analysisType) {
      console.log(`Prepare detailed analysis: ${analysisType}`);
      const clinicName = currentClinicForModal;
      if (!clinicName) {
          alert('クリニックが選択されていません。');
          return;
      }
      
      showLoading(true, `AIによる詳細分析中...\n(${getDetailedAnalysisTitleBase(analysisType)})`);
      showScreen('screen5');
      updateNavActiveState(null, null, analysisType);
      toggleEditDetailedAnalysis(false); // 編集モード強制解除
      
      const errorDiv = document.getElementById('detailed-analysis-error');
      errorDiv.classList.add('hidden');
      errorDiv.textContent = '';
      
      // UIのタイトル設定
      document.getElementById('detailed-analysis-title').textContent = `${clinicName} 詳細分析レポート`;
      document.getElementById('detailed-analysis-subtitle').textContent = `分析対象: ${getDetailedAnalysisTitleBase(analysisType)}`;
      
      // キャッシュキー
      const cacheKey = `${clinicName}-${analysisType}`;
      
      try {
          // 1. キャッシュ確認
          if (detailedAnalysisResultsCache[cacheKey]) {
              console.log("Using cached detailed analysis.");
              displayDetailedAnalysis(detailedAnalysisResultsCache[cacheKey], analysisType);
              switchTab('analysis'); // 常に最初のタブを表示
              showLoading(false);
              return;
          }

          // 2. キャッシュがない場合、元データを取得
          const clinicData = issuedReports[clinicName];
          if (!clinicData) throw new Error("レポートデータが見つかりません。");

          let textList = [];
          let totalCount = 0;
          
          // analysisType (L, I_good, I_bad, J, M) に応じてテキストリストを取得
          switch (analysisType) {
              case 'L':
                  textList = clinicData.npsData.rawText || [];
                  totalCount = clinicData.npsData.totalCount || 0;
                  break;
              case 'I_good':
                  // "良かった点" (I列) のテキストのみを抽出
                  textList = clinicData.feedbackData.i_column.results || [];
                  totalCount = clinicData.feedbackData.i_column.totalCount || 0;
                  break;
              case 'I_bad':
                  // "悪かった点" (I列) のテキストのみを抽出
                  // ★注意: 現在の 'i_column' には良い点と悪い点が混在している可能性があります。
                  // helpers.jsのプロンプトが 'I_bad' を期待しているため、ここでは 'i_column' をそのまま使いますが、
                  // 本来は 'I_bad' 専用のデータソース（例: 'i_bad_column'）が必要です。
                  // ここでは 'i_column' を '悪かった点' の分析対象として扱います。
                  textList = clinicData.feedbackData.i_column.results || [];
                  totalCount = clinicData.feedbackData.i_column.totalCount || 0;
                  console.warn("Analysis type 'I_bad' is using 'i_column' data. Ensure this is correct.");
                  break;
              case 'J':
                  textList = clinicData.feedbackData.j_column.results || [];
                  totalCount = clinicData.feedbackData.j_column.totalCount || 0;
                  break;
              case 'M':
                  textList = clinicData.feedbackData.m_column.results || [];
                  totalCount = clinicData.feedbackData.m_column.totalCount || 0;
                  break;
              default:
                  throw new Error(`無効な分析タイプです: ${analysisType}`);
          }
          
          console.log(`Analyzing ${textList.length} texts for ${analysisType} (Total raw count: ${totalCount})`);
          
          if (textList.length === 0) {
              throw new Error("分析対象のテキストデータが0件です。");
          }

          // 3. API呼び出し
          console.log(`Fetching detailed analysis from API for ${cacheKey}`);
          const response = await fetch('/api/generateDetailedAnalysis', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                  clinicName: clinicName,
                  columnType: analysisType,
                  textList: textList
              })
          });

          if (!response.ok) {
              const errorText = await response.text();
              console.error(`Detailed analysis API error (${response.status}):`, errorText);
              throw new Error(`AI分析APIエラー (${response.status}): ${errorText}`);
          }

          const analysisData = await response.json();
          console.log("Received detailed analysis data:", analysisData);

          // 4. キャッシュに保存
          detailedAnalysisResultsCache[cacheKey] = analysisData;

          // 5. 表示
          displayDetailedAnalysis(analysisData, analysisType);
          switchTab('analysis'); // 常に最初のタブを表示

      } catch (err) {
          console.error('!!! Detailed analysis failed:', err);
          errorDiv.textContent = `分析失敗: ${err.message}`;
          errorDiv.classList.remove('hidden');
          // エラー時もコンテンツエリアをクリア
          document.getElementById('analysis-title-area').innerHTML = '';
          document.getElementById('analysis-themes-area').innerHTML = '';
          document.getElementById('suggestions-title-area').innerHTML = '';
          document.getElementById('suggestions-items-area').innerHTML = '';
          document.getElementById('overall-title-area').innerHTML = '';
          document.getElementById('overall-summary-area').innerHTML = '';
      } finally {
          showLoading(false);
      }
  }

  /**
   * 取得した詳細分析データをHTMLにレンダリング
   */
  function displayDetailedAnalysis(data, analysisType) {
      if (!data || !data.analysis || !data.suggestions || !data.overall) {
          console.error("Invalid data structure for detailed analysis:", data);
          document.getElementById('detailed-analysis-error').textContent = 'AIから予期しないデータ形式が返されました。';
          document.getElementById('detailed-analysis-error').classList.remove('hidden');
          return;
      }

      // 1. 分析と考察 (Analysis)
      const analysisTitleArea = document.getElementById('analysis-title-area');
      const analysisThemesArea = document.getElementById('analysis-themes-area');
      analysisTitleArea.textContent = data.analysis.title || '分析と考察';
      analysisThemesArea.innerHTML = '';
      if (data.analysis.themes && data.analysis.themes.length > 0) {
          data.analysis.themes.forEach((theme, index) => {
              const themeEl = document.createElement('div');
              themeEl.className = 'border-b pb-4';
              themeEl.innerHTML = `
                  <h3 class="text-md font-semibold text-indigo-700 mb-2" data-key-item="analysis.themes.${index}.title">${theme.title}</h3>
                  <p class="text-sm text-gray-600 leading-relaxed whitespace-pre-wrap" data-key-item="analysis.themes.${index}.summary">${theme.summary}</p>
              `;
              analysisThemesArea.appendChild(themeEl);
          });
      } else {
          analysisThemesArea.innerHTML = '<p class="text-gray-500">テーマが見つかりませんでした。</p>';
      }

      // 2. 改善提案 (Suggestions)
      const suggestionsTitleArea = document.getElementById('suggestions-title-area');
      const suggestionsItemsArea = document.getElementById('suggestions-items-area');
      suggestionsTitleArea.textContent = data.suggestions.title || '改善提案';
      suggestionsItemsArea.innerHTML = '';
      if (data.suggestions.items && data.suggestions.items.length > 0) {
          data.suggestions.items.forEach((item, index) => {
              const itemEl = document.createElement('div');
              itemEl.className = 'border-b pb-4';
              itemEl.innerHTML = `
                  <h3 class="text-md font-semibold text-gray-700 mb-2" data-key-item="suggestions.items.${index}.themeTitle">${item.themeTitle}</h3>
                  <p class="text-sm text-gray-600 leading-relaxed whitespace-pre-wrap" data-key-item="suggestions.items.${index}.suggestion">${item.suggestion}</p>
              `;
              suggestionsItemsArea.appendChild(itemEl);
          });
      } else {
          suggestionsItemsArea.innerHTML = '<p class="text-gray-500">提案が見つかりませんでした。</p>';
      }

      // 3. 総評 (Overall)
      const overallTitleArea = document.getElementById('overall-title-area');
      const overallSummaryArea = document.getElementById('overall-summary-area');
      overallTitleArea.textContent = data.overall.title || '総評';
      overallSummaryArea.textContent = data.overall.summary || '総評がありません。';
  }

  /**
   * 分析タイプの表示名を取得
   */
  function getDetailedAnalysisTitleBase(analysisType) {
      switch (analysisType) {
          case 'L': return 'NPS推奨度 理由';
          case 'I_good': return '良かった点';
          case 'I_bad': return '悪かった点';
          case 'J': return '印象に残ったスタッフへのコメント';
          case 'M': return 'お産にかかわるご意見・ご感想';
          default: return '不明';
      }
  }

  /**
   * タブクリック処理
   */
  function handleTabClick(event) {
      const tabId = event.target.dataset.tabId;
      if (tabId) {
          switchTab(tabId);
      }
  }

  /**
   * タブ切り替え
   */
  function switchTab(tabId) {
      // 編集モード中はタブ切り替え不可
      if (isEditingDetailedAnalysis) {
          alert('編集モードを終了（保存またはキャンセル）してください。');
          return;
      }
      
      // ボタンのアクティブ状態
      document.querySelectorAll('#screen5 .tab-button').forEach(button => {
          if (button.dataset.tabId === tabId) {
              button.classList.add('active');
          } else {
              button.classList.remove('active');
          }
      });
      // コンテンツの表示状態
      document.querySelectorAll('#screen5 .tab-content').forEach(content => {
          if (content.id === `content-${tabId}`) {
              content.classList.remove('hidden');
          } else {
              content.classList.add('hidden');
          }
      });
  }


  // --- ▼▼▼ 詳細分析 編集関連関数 ▼▼▼

  /**
   * 編集モードのトグル
   */
  function toggleEditDetailedAnalysis(forceEdit = null) {
      isEditingDetailedAnalysis = (forceEdit !== null) ? forceEdit : !isEditingDetailedAnalysis;
      
      const contentArea = document.getElementById('detailed-analysis-content-area');
      const editBtn = document.getElementById('edit-detailed-analysis-btn');
      const saveBtn = document.getElementById('save-detailed-analysis-btn');
      const cancelBtn = document.getElementById('cancel-edit-detailed-analysis-btn');
      
      // 編集対象の全要素 (p, h2, h3)
      const textElements = contentArea.querySelectorAll('[data-key-title], [data-key-item], [data-key-summary]');

      if (isEditingDetailedAnalysis) {
          // 編集モードへ
          editBtn.classList.add('hidden');
          saveBtn.classList.remove('hidden');
          cancelBtn.classList.remove('hidden');

          textElements.forEach(el => {
              const currentText = el.textContent;
              const key = el.dataset.keyTitle || el.dataset.keyItem || el.dataset.keySummary;
              
              if (el.tagName === 'P' || el.dataset.keySummary) {
                  // Pタグや総評は <textarea> に
                  const textarea = document.createElement('textarea');
                  textarea.className = 'w-full h-32 p-2 border border-blue-300 rounded focus:ring-2 focus:ring-blue-500 focus:outline-none';
                  textarea.value = currentText;
                  textarea.dataset.originalKey = key;
                  el.innerHTML = '';
                  el.appendChild(textarea);
              } else {
                  // H2, H3 は <input> に
                  const input = document.createElement('input');
                  input.type = 'text';
                  input.className = 'w-full p-1 border border-blue-300 rounded focus:ring-2 focus:ring-blue-500 focus:outline-none';
                  input.value = currentText;
                  input.dataset.originalKey = key;
                  el.innerHTML = '';
                  el.appendChild(input);
              }
          });

      } else {
          // 表示モードへ（編集内容を破棄して再描画）
          editBtn.classList.remove('hidden');
          saveBtn.classList.add('hidden');
          cancelBtn.classList.add('hidden');
          
          // キャッシュからデータを再取得して表示を元に戻す
          const cacheKey = `${currentClinicForModal}-${currentDetailedAnalysisType}`;
          if (detailedAnalysisResultsCache[cacheKey]) {
              displayDetailedAnalysis(detailedAnalysisResultsCache[cacheKey], currentDetailedAnalysisType);
          }
      }
  }

  /**
   * 編集内容を保存
   */
  function saveDetailedAnalysisEdits() {
      const cacheKey = `${currentClinicForModal}-${currentDetailedAnalysisType}`;
      if (!detailedAnalysisResultsCache[cacheKey]) {
          alert('キャッシュデータが見つかりません。');
          return;
      }
      
      const updatedData = JSON.parse(JSON.stringify(detailedAnalysisResultsCache[cacheKey])); // ディープコピー
      const contentArea = document.getElementById('detailed-analysis-content-area');
      const inputs = contentArea.querySelectorAll('input[data-original-key], textarea[data-original-key]');

      try {
          inputs.forEach(input => {
              const key = input.dataset.originalKey;
              const value = input.value;
              
              // 'analysis.themes.0.title' のようなキーを解決
              const keys = key.split('.');
              let current = updatedData;
              for (let i = 0; i < keys.length - 1; i++) {
                  current = current[keys[i]];
              }
              current[keys[keys.length - 1]] = value;
          });

          // キャッシュを更新
          detailedAnalysisResultsCache[cacheKey] = updatedData;
          console.log("Updated cache:", updatedData);
          
          // 編集モード終了（表示を更新）
          toggleEditDetailedAnalysis(false);
          alert('変更を保存しました。');

      } catch (e) {
          console.error("Failed to save edits:", e);
          alert('保存中にエラーが発生しました。');
      }
  }

  /**
   * 編集をキャンセル
   */
  function cancelEditDetailedAnalysis() {
      if (confirm('編集内容を破棄しますか？')) {
          toggleEditDetailedAnalysis(false); // 編集モードを終了（再描画される）
      }
  }
  
  // --- ▲▲▲ 詳細分析 編集関連関数 ▲▲▲ ---

  // --- ▲▲▲ 詳細分析関連 (JS関数追加) ▲▲▲ ---

  // --- 汎用関数 (変更なし) ---
  // ▼▼▼ updateNavActiveState (変更あり) ▼▼▼
  function updateNavActiveState(activeReportType, activeAnalysisType, activeDetailedAnalysisType) {
    document.querySelectorAll('#report-nav .btn').forEach(btn => {
        if ((activeReportType && btn.dataset.reportType === activeReportType) ||
            (activeAnalysisType && btn.dataset.analysisType === activeAnalysisType) ||
            (activeDetailedAnalysisType && btn.dataset.detailedAnalysisType === activeDetailedAnalysisType)) {
            btn.classList.add('btn-active');
        } else {
            btn.classList.remove('btn-active');
        }
    });
  }
  // ▲▲▲ updateNavActiveState (変更あり) ▲▲▲
  function showScreen(screenId){ document.querySelectorAll('.screen').forEach(el=>el.classList.add('hidden'));document.getElementById(screenId).classList.remove('hidden'); }
  function showLoading(isLoading, message=''){ const o=document.getElementById('loading-overlay'),m=document.getElementById('loading-message');if(isLoading){m.textContent=message;o.classList.remove('hidden');}else{o.classList.add('hidden');m.textContent='';} }
  function showReportModal(show){ const m=document.getElementById('report-type-modal'),c=m.querySelector('div');if(show){m.classList.remove('hidden');setTimeout(()=>{c.classList.remove('scale-95','opacity-0');},10);}else{c.classList.add('scale-95','opacity-0');setTimeout(()=>{m.classList.add('hidden');},300);} }
  async function generatePdf(){ console.log('PDF export clicked.');const cn=currentClinicForModal;const pt=document.getElementById('period-display').textContent.replace('集計期間：','');const rd=issuedReports[cn];if(!cn||!pt||!rd){alert('PDF生成に必要なレポートデータがありません。');return;} showLoading(true,'PDFを生成中...');try{const r=await fetch('/generate-pdf',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({clinicName:cn,periodText:pt,reportData:rd})});if(!r.ok){let em=`サーバーエラー: ${r.status} ${r.statusText}`;try{const ed=await r.text();em+=`\n${ed}`;}catch(e){} throw new Error(em);} const b=await r.blob();const u=window.URL.createObjectURL(b);const a=document.createElement('a');a.style.display='none';a.href=u;document.body.appendChild(a);a.click();window.URL.revokeObjectURL(u);a.remove();showLoading(false);}catch(error){console.error('PDF gen error:',error);alert('PDF生成失敗\n'+error.message);showLoading(false);} }
</script>
</body>
</html>
