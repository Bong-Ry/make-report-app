<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>レポートアプリ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.1.1/wordcloud2.min.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* (変更なし) */
    body{font-family:'Noto Sans JP',sans-serif;background-color:#f8f7f7;}
    .btn{@apply py-2 px-6 border border-gray-800 text-gray-800 transition-all duration-300 rounded-md text-sm font-bold tracking-wider shadow-sm whitespace-nowrap;}
    .btn:hover:not(:disabled){@apply bg-gray-800 text-white shadow-md transform -translate-y-px;}
    .btn:disabled{@apply border-gray-300 text-gray-400 cursor-not-allowed bg-gray-100 shadow-none;}
    .btn-active{@apply bg-gray-800 text-white shadow-md transform -translate-y-px;}
    .select-box{@apply block w-full p-3 bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-800 focus:border-transparent transition-shadow;}
    .screen{@apply w-full max-w-7xl mx-auto p-4 md:p-8;}
    .card{@apply bg-white p-6 md:p-8 shadow-lg rounded-xl border border-gray-200;}
    #loading-overlay > div > div { border-top-color: #333; border-bottom-color: #333; }
    /* ★ ワードクラウド用 */
    #word-cloud-canvas { width: 100%; height: 400px; border: 1px solid #e5e7eb; border-radius: 0.5rem; background-color: #f9fafb; }
    /* ★ 棒グラフ用 */
    .chart-container { height: 500px; /* グラフの高さ */ overflow-y: auto; /* 単語が多い場合にスクロール */ border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; background-color: #f9fafb;}
  </style>
</head>
<body class="text-gray-900">

  <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50 hidden"><div class="flex flex-col items-center"><div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-gray-800"></div><p id="loading-message" class="mt-4 text-lg font-semibold text-gray-800"></p></div></div>

  <div id="screen1" class="screen"> <div class="card max-w-lg mx-auto mt-12"> <div class="text-center mb-8"> <h1 class="text-2xl font-bold text-gray-800">集計期間の選択</h1> <p class="text-sm text-gray-500 mt-2">レポートを生成する期間を設定してください。</p> </div> <div class="space-y-6"> <div> <label for="start-year" class="font-bold text-gray-700 mb-2 block text-sm">開始年月</label> <div class="grid grid-cols-2 gap-4"> <select id="start-year" class="select-box"></select> <select id="start-month" class="select-box"></select> </div> </div> <div> <label for="end-year" class="font-bold text-gray-700 mb-2 block text-sm">終了年月</label> <div class="grid grid-cols-2 gap-4"> <select id="end-year" class="select-box"></select> <select id="end-month" class="select-box"></select> </div> </div> <div class="pt-4 border-t mt-6"> <button id="next-to-clinics" class="btn w-full bg-gray-800 text-white hover:bg-gray-700">次へ進む</button> </div> </div> </div> </div>

  <div id="screen2" class="screen hidden"> <header class="flex justify-between items-center mb-6 pb-4 border-b"> <button id="back-to-period" class="btn">&lt; 期間選択へ戻る</button> <div id="period-display" class="text-base font-semibold text-gray-700 bg-white py-2 px-4 rounded-lg shadow-sm border"></div> </header> <main class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:px-8"> <section class="card"> <h2 class="text-xl font-bold mb-5">1. クリニックを選択</h2> <div id="clinic-list-container" class="space-y-3 max-h-96 overflow-y-auto pr-2 border rounded-lg p-4 bg-gray-50"> <p class="text-sm text-gray-500 text-center py-4">読み込み中...</p> </div> <div class="mt-6 text-right"> <button id="issue-btn" class="btn bg-gray-800 text-white hover:bg-gray-700" disabled>レポート発行</button> </div> </section> <section class="card"> <h2 class="text-xl font-bold mb-5">2. 発行済みレポートを閲覧</h2> <div id="issued-list-container" class="space-y-3"> <p class="text-sm text-gray-500 text-center py-8">まだ発行されたレポートはありません。</p> </div> </section> </main> </div>

  <div id="screen3" class="screen hidden"> <header class="mb-6 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0 pb-6 border-b border-gray-200"> <div id="report-nav" class="flex flex-wrap justify-center items-center gap-2"> <button data-report-type="nps" class="btn">NPS推奨度 理由</button> <button data-report-type="feedback_i" class="btn">良かった点・悪かった点</button> <button data-report-type="feedback_j" class="btn">印象に残ったスタッフ</button> <button data-report-type="feedback_m" class="btn">お産にかかわるご意見</button> <button data-report-type="satisfaction_b" class="btn">満足度</button> <button data-report-type="satisfaction_c" class="btn">施設</button> <button data-report-type="satisfaction_d" class="btn">アクセス</button> <button data-report-type="satisfaction_e" class="btn">価格</button> <button data-report-type="satisfaction_f" class="btn">雰囲気</button> <button data-report-type="satisfaction_g" class="btn">スタッフ対応</button> <button data-report-type="satisfaction_h" class="btn">先生の説明</button> <button data-report-type="age" class="btn">年代</button> <button data-report-type="children" class="btn">お子様の数</button> <button data-report-type="income" class="btn">世帯年収</button> </div> <div class="flex items-center gap-4"> <button id="pdf-export-btn" class="btn bg-gray-800 text-white hover:bg-gray-700">PDF出力</button> <button id="back-to-clinics" class="btn">院一覧へ戻る</button> </div> </header> <main class="card"> <div class="text-center mb-8 pb-4 border-b"> <h1 id="report-title" class="text-2xl font-bold"></h1> <p id="report-subtitle" class="text-sm text-gray-600 mt-2" style="white-space: pre-wrap;"></p> </div> <div id="slider-container" class="relative"> <div id="slide-content" class="bg-gray-50 border p-6 md:p-8 rounded-lg min-h-[500px]"> <h2 id="slide-header" class="text-xl font-bold mb-5 text-gray-800"></h2> <div id="slide-body" class="text-base leading-relaxed text-gray-700" style="white-space: pre-wrap;"></div> </div> <div id="pagination" class="flex items-center justify-center mt-6"> <button id="prev-slide" class="btn">&lt; 前へ</button> <span id="page-indicator" class="mx-6 text-base font-semibold text-gray-600"></span> <button id="next-slide" class="btn">次へ &gt;</button> </div> </div> </main> </div>

  <div id="screen4" class="screen hidden">
      <header class="mb-6 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0 pb-6 border-b border-gray-200">
        <div id="analysis-nav" class="flex flex-wrap justify-center items-center gap-2">
            <button data-analysis-type="L" class="btn">分析-NPS結果</button>
            <button data-analysis-type="I" class="btn">分析-良かった点悪かった点</button>
            <button data-analysis-type="J" class="btn">分析-印象に残ったスタッフ</button>
            <button data-analysis-type="M" class="btn">分析-お産に関わるご意見</button>
        </div>
        <div class="flex items-center gap-4">
             <button id="back-to-clinics-from-analysis" class="btn">院一覧へ戻る</button>
        </div>
      </header>
      <main class="card">
         <div class="text-center mb-8 pb-4 border-b">
             <h1 id="analysis-title" class="text-2xl font-bold"></h1>
             <p class="text-sm text-gray-500 mt-2">
                 文章中に出現する単語の頻出度を表にしています。単語ごとに表示されている「スコア」の大きさは、その単語がどれだけ特徴的であるかを表しています。<br>
                 通常はその単語の出現回数が多いほどスコアが高くなるが、「言う」や「思う」など、どの文書にもよく現れる単語についてはスコアが低めになります。
             </p>
         </div>

         <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
             <div class="space-y-4">
                 <div id="noun-chart-container" class="chart-container">
                     <h3 class="font-bold text-center mb-2 text-blue-600">名詞</h3>
                     <div id="noun-chart"></div>
                 </div>
                 <div id="verb-chart-container" class="chart-container">
                     <h3 class="font-bold text-center mb-2 text-red-600">動詞</h3>
                     <div id="verb-chart"></div>
                 </div>
                 <div id="adj-chart-container" class="chart-container">
                     <h3 class="font-bold text-center mb-2 text-green-600">形容詞</h3>
                     <div id="adj-chart"></div>
                 </div>
                 <div id="int-chart-container" class="chart-container">
                      <h3 class="font-bold text-center mb-2 text-gray-600">感動詞</h3>
                      <div id="int-chart"></div>
                 </div>
             </div>

             <div class="space-y-6">
                 <div>
                     <p class="text-sm text-gray-600">
                         ワードクラウドスコアが高い単語を複数選び出し、その値に応じた大きさで図示しています。<br>
                         単語の色は品詞の種類で異なる。<br>
                         <span class="text-blue-600 font-semibold">青色=名詞</span>、
                         <span class="text-red-600 font-semibold">赤色=動詞</span>、
                         <span class="text-green-600 font-semibold">緑色=形容詞</span>、
                         <span class="text-gray-600 font-semibold">灰色=感動詞</span>
                     </p>
                 </div>
                 <div id="word-cloud-container">
                     <canvas id="word-cloud-canvas"></canvas>
                 </div>
                 <div id="analysis-error" class="text-red-500 text-sm text-center hidden"></div>
             </div>
         </div>
      </main>
  </div>
  <div id="report-type-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-40 hidden"><div class="bg-white p-8 shadow-xl w-full max-w-md rounded-xl transform transition-all duration-300 scale-95 opacity-0"><h2 class="text-xl font-bold mb-6 text-center">表示するレポートを選択</h2><div class="flex flex-wrap justify-center gap-3"><button data-report-type="nps" class="btn">NPS推奨度 理由</button><button data-report-type="feedback_i" class="btn">良かった点・悪かった点</button><button data-report-type="feedback_j" class="btn">印象に残ったスタッフ</button><button data-report-type="feedback_m" class="btn">お産にかかわるご意見</button><button data-report-type="satisfaction_b" class="btn">満足度</button><button data-report-type="satisfaction_c" class="btn">施設</button><button data-report-type="satisfaction_d" class="btn">アクセス</button><button data-report-type="satisfaction_e" class="btn">価格</button><button data-report-type="satisfaction_f" class="btn">雰囲気</button><button data-report-type="satisfaction_g" class="btn">スタッフ対応</button><button data-report-type="satisfaction_h" class="btn">先生の説明</button><button data-report-type="age" class="btn">年代</button><button data-report-type="children" class="btn">お子様の数</button><button data-report-type="income" class="btn">世帯年収</button></div><div class="mt-8 text-center"><button id="cancel-report-selection" class="text-sm text-gray-600 hover:underline">キャンセル</button></div></div></div>

<script>
  let selectedPeriod = {};
  let issuedReports = {};
  let currentClinicForModal = '';
  let slidesData = [];
  let currentPage = 1;
  let currentAnalysisTarget = 'L'; // ★ 現在分析中の列 (L, I, J, M)

  const googleChartsLoaded = new Promise(resolve => {
    google.charts.load('current', {'packages':['corechart', 'bar']}); // ★ barチャートもロード
    google.charts.setOnLoadCallback(resolve);
  });

  document.addEventListener('DOMContentLoaded', async () => { /* (変更なし) */
    console.log('DOM Content Loaded. Initializing...'); populateDateSelectors();
    try { await googleChartsLoaded; console.log('Google Charts loaded.'); } catch (err) { console.error('Failed to load Google Charts:', err); alert('グラフライブラリ読込失敗'); return; }
    setupEventListeners(); console.log('Event listeners set up.');
  });

  function setupEventListeners() { /* (分析画面用のリスナー追加) */
    document.getElementById('next-to-clinics').addEventListener('click', handleNextToClinics);
    document.getElementById('issue-btn').addEventListener('click', handleIssueReport);
    document.getElementById('issued-list-container').addEventListener('click', handleIssuedListClick);
    document.getElementById('report-type-modal').addEventListener('click', handleReportModalClick);
    document.getElementById('report-nav').addEventListener('click', handleReportNavClick);
    document.getElementById('cancel-report-selection').addEventListener('click', () => showReportModal(false));
    document.getElementById('prev-slide').addEventListener('click', handlePrevSlide);
    document.getElementById('next-slide').addEventListener('click', handleNextSlide);
    document.getElementById('back-to-clinics').addEventListener('click', () => showScreen('screen2'));
    document.getElementById('back-to-period').addEventListener('click', () => showScreen('screen1'));
    document.getElementById('pdf-export-btn').addEventListener('click', generatePdf);
    // ★ 分析画面用
    document.getElementById('analysis-nav').addEventListener('click', handleAnalysisNavClick);
    document.getElementById('back-to-clinics-from-analysis').addEventListener('click', () => showScreen('screen2'));
  }

  // --- 画面1 (変更なし) ---
  function populateDateSelectors() { /* (変更なし) */ const now=new Date();const cy=now.getFullYear();const sy=document.getElementById('start-year'),ey=document.getElementById('end-year');for(let i=0;i<5;i++){const y=cy-i;sy.add(new Option(`${y}年`,y));ey.add(new Option(`${y}年`,y));} const sm=document.getElementById('start-month'),em=document.getElementById('end-month');for(let i=1;i<=12;i++){const m=String(i).padStart(2,'0');sm.add(new Option(`${i}月`,m));em.add(new Option(`${i}月`,m));} em.value=String(now.getMonth()+1).padStart(2,'0');sm.value=String(now.getMonth()+1).padStart(2,'0'); }
  function handleNextToClinics() { /* (変更なし) */ console.log('Next clicked.');const sy=document.getElementById('start-year').value,sm=document.getElementById('start-month').value,ey=document.getElementById('end-year').value,em=document.getElementById('end-month').value;const sd=new Date(`${sy}-${sm}-01`),ed=new Date(`${ey}-${em}-01`);if(sd>ed){console.warn('Start>End.');alert('開始年月<=終了年月で設定');document.getElementById('start-year').classList.add('border-red-500');document.getElementById('start-month').classList.add('border-red-500');return;} document.getElementById('start-year').classList.remove('border-red-500');document.getElementById('start-month').classList.remove('border-red-500');selectedPeriod={start:`${sy}-${sm}`,end:`${ey}-${em}`};document.getElementById('period-display').textContent=`集計期間：${sy}年${sm}月～${ey}年${em}月`;console.log('Period:',selectedPeriod);showScreen('screen2');if(Object.keys(issuedReports).length===0){console.log('Loading clinics...');loadClinics();}else{console.log('Clinics already loaded.');} }

  // --- 画面2 (変更なし) ---
  async function loadClinics() { /* (変更なし) */ console.log('loadClinics...');showLoading(true,'クリニック一覧読込中...');const c=document.getElementById('clinic-list-container');c.innerHTML='<p class="text-sm text-gray-500 text-center py-4">読込中...</p>';try{console.log('Fetching list...');const r=await fetch('/api/getClinicList');console.log('Status:',r.status);if(!r.ok){const et=await r.text();console.error('Error:',r.status,et);throw new Error(`サーバーエラー(${r.status}): ${et}`);} const clinics=await r.json();console.log('Received:',clinics);c.innerHTML='';if(!Array.isArray(clinics)){console.error('Not array:',clinics);throw new Error('予期しないデータ形式');} if(clinics.length===0){console.log('None found.');c.innerHTML='<p class="text-sm text-gray-500 text-center py-4">対象なし</p>';}else{clinics.forEach(n=>{const d=document.createElement('div');d.className='flex items-center p-2 rounded-md hover:bg-gray-100';d.innerHTML=`<input type="checkbox" id="clinic-${n}" name="clinic" value="${n}" class="mr-3 h-4 w-4 rounded border-gray-300 text-gray-800 focus:ring-gray-800 cursor-pointer"><label for="clinic-${n}" class="text-sm select-none cursor-pointer">${n}</label>`;c.appendChild(d);});console.log('Populated.');c.removeEventListener('change',handleClinicCheckboxChange);c.addEventListener('change',handleClinicCheckboxChange);} showLoading(false);}catch(err){console.error('!!! Load failed:',err);c.innerHTML=`<p class="text-sm text-red-500 text-center py-4">読込失敗<br>${err.message}</p>`;showLoading(false);} }
  function handleClinicCheckboxChange() { /* (変更なし) */ const checked=document.querySelectorAll('#clinic-list-container input:checked').length;document.getElementById('issue-btn').disabled=checked===0; }
  async function handleIssueReport() { /* (変更なし) */ console.log('Issue report.');showLoading(true,'レポートデータ取得中...');const sc=Array.from(document.querySelectorAll('#clinic-list-container input:checked')).map(cb=>cb.value);console.log('Selected:',sc);try{console.log('Posting...');const r=await fetch('/api/getReportData',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({period:selectedPeriod,selectedClinics:sc})});console.log('Status:',r.status);if(!r.ok){const et=await r.text();console.error('Error:',r.status,et);throw new Error(`サーバーエラー(${r.status}): ${et}`);} const data=await r.json();console.log('Received data:',data);const ts=new Date().toLocaleString('ja-JP',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});let rg=false;Object.keys(data).forEach(cn=>{if(sc.includes(cn)){issuedReports[cn]={...data[cn],timestamp:ts};rg=true;console.log(`Stored for ${cn}`);}});if(rg){updateIssuedList();currentClinicForModal=sc[0];if(currentClinicForModal&&issuedReports[currentClinicForModal]){console.log(`Show modal for ${currentClinicForModal}`);showReportModal(true);}else{console.warn('Generated but no data for first selection:',currentClinicForModal);}}else{console.warn('Data received but empty/no match.');alert('データ取得失敗または対象なし');} showLoading(false);}catch(err){console.error('!!! Issue failed:',err);alert(`発行失敗\n${err.message}`);showLoading(false);} }
  function updateIssuedList() { /* (変更なし) */ const c=document.getElementById('issued-list-container');c.innerHTML='';const cn=Object.keys(issuedReports);if(cn.length===0){c.innerHTML='<p class="text-sm text-gray-500 text-center py-8">発行済レポートなし</p>';return;} cn.forEach(n=>{const d=document.createElement('div');d.className='p-4 border rounded-lg cursor-pointer hover:bg-gray-50 hover:shadow-md transition-all duration-200';d.dataset.clinicName=n;d.innerHTML=`<p class="font-bold text-base">${n}</p><p class="text-xs text-gray-500 mt-1">発行日時: ${issuedReports[n].timestamp}</p>`;c.appendChild(d);});console.log('Issued list updated.'); }

  // --- 画面3 (変更なし) ---
  function handleIssuedListClick(e){ /* (変更なし) */ const t=e.target.closest('[data-clinic-name]');if(t){currentClinicForModal=t.dataset.clinicName;if(issuedReports[currentClinicForModal]){showReportModal(true);}} }
  function handleReportModalClick(e){ /* (変更なし) */ const rt=e.target.dataset.reportType;if(rt){showReportModal(false);setTimeout(()=>prepareAndShowReport(rt),300);} }
  function handleReportNavClick(e){ /* (変更なし) */ const rt=e.target.dataset.reportType;if(rt){prepareAndShowReport(rt);} }
  function prepareAndShowReport(reportType){ /* (変更なし - 既存レポート表示) */ console.log(`Prepare report: ${reportType}`); showLoading(true,'レポート準備中...');updateNavActiveState(reportType);const cd=issuedReports[currentClinicForModal];if(!cd){showLoading(false);return;} slidesData=[];document.getElementById('pagination').style.display='flex';document.getElementById('slide-body').style.whiteSpace='pre-wrap';document.getElementById('slide-header').innerHTML='';document.getElementById('slide-body').innerHTML='';let isChart=false,isBar=false; if (reportType === 'nps'){const{totalCount,results}=cd.npsData;prepareNpsSlides(results,`NPS理由(全${totalCount}件)`);} else if (reportType === 'feedback_i'){prepareCommentSlides(cd.feedbackData.i_column,'良かった点悪かった点');} else if (reportType === 'feedback_j'){prepareCommentSlides(cd.feedbackData.j_column,'印象に残ったスタッフ');} else if (reportType === 'feedback_m'){prepareCommentSlides(cd.feedbackData.m_column,'お産意見感想');} else if (reportType === 'satisfaction_b'){prepareChartShell('満足度','5段階評価');isChart=true;} else if (reportType === 'satisfaction_c'){prepareChartShell('施設','5段階評価');isChart=true;} else if (reportType === 'satisfaction_d'){prepareChartShell('アクセス','5段階評価');isChart=true;} else if (reportType === 'satisfaction_e'){prepareChartShell('価格','5段階評価');isChart=true;} else if (reportType === 'satisfaction_f'){prepareChartShell('雰囲気','5段階評価');isChart=true;} else if (reportType === 'satisfaction_g'){prepareChartShell('スタッフ対応','5段階評価');isChart=true;} else if (reportType === 'satisfaction_h'){prepareChartShell('先生説明','5段階評価');isChart=true;} else if (reportType === 'age'){prepareChartShell('年代','');isChart=true;} else if (reportType === 'children'){prepareChartShell('お子様数','1人, 2人, 3人, 4人, 5人以上');isChart=true;} else if (reportType === 'income'){prepareChartShell('世帯年収','',true);isChart=true;isBar=true;} if(slidesData.length>0){currentPage=1;renderSlide(currentPage);}else if(slidesData.length===0&&(reportType.startsWith('nps')||reportType.startsWith('feedback'))){document.getElementById('slide-header').innerHTML='';document.getElementById('slide-body').innerHTML='<p class="text-center text-gray-500">該当データなし</p>';document.getElementById('pagination').style.display='none';} showScreen('screen3'); if(isChart){setTimeout(()=>{try{let data;if(reportType.startsWith('satisfaction')){data=cd.satisfactionData[reportType.split('_')[1]+'_column'];drawSatisfactionCharts(data.results);}else if(reportType==='age'){data=cd.ageData;drawSatisfactionCharts(data.results);}else if(reportType==='children'){data=cd.childrenCountData;drawSatisfactionCharts(data.results);}else if(reportType==='income'){data=cd.incomeData;drawIncomeCharts(data);}}catch(e){console.error('Chart draw error:',e);document.getElementById('slide-body').innerHTML='<p class="text-center text-red-500">グラフ描画失敗</p>';}finally{showLoading(false);}},100);}else{showLoading(false);} }
  function prepareNpsSlides(results, title){ /* (変更なし) */ document.getElementById('report-title').textContent=title;document.getElementById('report-subtitle').textContent='';const ml=20;if(!results)return;const sc=Object.keys(results).map(Number).sort((a,b)=>b-a);sc.forEach(s=>{const rs=results[s];if(!rs||rs.length===0)return;let clc=0,cpb='';rs.forEach((r,i)=>{const rt=`・ ${r}`;const rl=(rt.match(/\n/g)||[]).length+1;if(clc>0&&(clc+rl)>ml){slidesData.push({header:`推奨度 ${s}(${rs.length}人)`,body:cpb});cpb=rt;clc=rl;}else{cpb+=(clc===0?'':'\n')+rt;clc+=rl;}});if(cpb){slidesData.push({header:`推奨度 ${s}(${rs.length}人)`,body:cpb});}}); }
  function prepareCommentSlides(data, title){ /* (変更なし) */ if(!data)data={totalCount:0,results:[]};const{totalCount,results}=data;document.getElementById('report-title').textContent=`${title}(全${totalCount}件)`;document.getElementById('report-subtitle').textContent='';const ml=20;if(results&&results.length>0){let clc=0,cpb='';results.forEach((it,i)=>{const itx=`・ ${it}`;const il=(itx.match(/\n/g)||[]).length+1;if(clc>0&&(clc+il)>ml){slidesData.push({header:'',body:cpb});cpb=itx;clc=il;}else{cpb+=(clc===0?'':'\n')+itx;clc+=il;}});if(cpb){slidesData.push({header:'',body:cpb});}} }
  function prepareChartShell(title, subtitle, isBar=false){ /* (変更なし) */ document.getElementById('report-title').textContent=`アンケート結果 ー${title}ー`;document.getElementById('report-subtitle').textContent=subtitle;document.getElementById('pagination').style.display='none';document.getElementById('slide-body').style.whiteSpace='normal';const cid=isBar?'bar-chart':'pie-chart',hc=isBar?'h-[350px]':'h-[400px]';document.getElementById('slide-body').innerHTML=`<div class="grid grid-cols-1 md:grid-cols-2 gap-8"><div class="flex flex-col items-center"><h3 class="font-bold text-lg mb-4 text-center">貴院の結果</h3><div id="clinic-${cid}" class="w-full ${hc}"></div></div><div class="flex flex-col items-center"><h3 class="font-bold text-lg mb-4 text-center">（参照）全体平均</h3><div id="average-${cid}" class="w-full ${hc}"></div></div></div>`; }
  function renderSlide(page){ /* (変更なし) */ if(page<1||page>slidesData.length)return;const s=slidesData[page-1];document.getElementById('slide-header').innerHTML=s.header;document.getElementById('slide-body').innerHTML=s.body;document.getElementById('page-indicator').textContent=`${page} / ${slidesData.length}`;document.getElementById('prev-slide').disabled=(page===1);document.getElementById('next-slide').disabled=(page===slidesData.length); }
  function drawSatisfactionCharts(chartData){ /* (変更なし - 平均データは固定のまま) */ const opt={is3D:true,chartArea:{left:'5%',top:'5%',width:'90%',height:'90%'},pieSliceText:'percentage',pieSliceTextStyle:{color:'black',fontSize:16,bold:true},legend:{position:'labeled',textStyle:{color:'black',fontSize:14}},tooltip:{showColorCode:true,textStyle:{fontSize:14},trigger:'focus'},colors:['#4285F4','#DB4437','#F4B400','#0F9D58','#990099']};const cd=document.getElementById('clinic-pie-chart');if(chartData&&chartData.length>1){const d=google.visualization.arrayToDataTable(chartData);const c=new google.visualization.PieChart(cd);c.draw(d,opt);}else{cd.innerHTML='<div class="flex items-center justify-center h-full"><p class="text-gray-500">データなし</p></div>';} const avgD=google.visualization.arrayToDataTable([['満足度','割合'],['非常に満足',73.5],['満足',24.2],['ふつう',2.0],['不満',0.3],['非常に不満',0]]);const avgC=new google.visualization.PieChart(document.getElementById('average-pie-chart'));avgC.draw(avgD,opt); }
  function drawIncomeCharts({results,totalCount}){ /* (変更なし - 平均データは固定のまま) */ const opt={legend:{position:'none'},colors:['#DE5D83'],annotations:{textStyle:{fontSize:12,color:'black',auraColor:'none'},alwaysOutside:false,stem:{color:'transparent'}},vAxis:{format:'#'+'%\'',viewWindow:{min:0}},hAxis:{}};const ccd=document.getElementById('clinic-bar-chart');if(totalCount>0&&results&&results.length>1){const cd=google.visualization.arrayToDataTable(results);const cc=new google.visualization.ColumnChart(ccd);cc.draw(cd,opt);}else{ccd.innerHTML='<div class="flex items-center justify-center h-full"><p class="text-gray-500">データなし</p></div>';} const avgD=google.visualization.arrayToDataTable([['評価','割合',{role:'annotation'}],['1',1,'1%'],['2',2,'2%'],['3',7,'7%'],['4',12,'12%'],['5',16,'16%'],['6',16,'16%'],['7',13,'13%'],['8',12,'12%'],['9',8,'8%'],['10',15,'15%']]);const avgC=new google.visualization.ColumnChart(document.getElementById('average-bar-chart'));avgC.draw(avgD,opt); }
  function handlePrevSlide(){ /* (変更なし) */ if(currentPage>1){currentPage--;renderSlide(currentPage);} }
  function handleNextSlide(){ /* (変更なし) */ if(currentPage<slidesData.length){currentPage++;renderSlide(currentPage);} }

  // --- ★★★ 新しい関数群: テキスト分析表示用 ★★★ ---

  // 分析画面のナビゲーションクリック処理
  function handleAnalysisNavClick(e) {
      const analysisType = e.target.dataset.analysisType; // L, I, J, M
      if (analysisType) {
          console.log(`Analysis nav clicked: ${analysisType}`);
          currentAnalysisTarget = analysisType; // 分析対象を更新
          prepareAndShowAnalysis(analysisType);
          updateAnalysisNavActiveState(analysisType); // ★ アクティブ表示更新
      }
  }

  // 分析画面表示準備とAPI呼び出し
  async function prepareAndShowAnalysis(columnType) {
      showLoading(true, `テキスト分析中 (${getColumnName(columnType)})...`);
      showScreen('screen4'); // 分析画面を表示
      document.getElementById('analysis-error').classList.add('hidden'); // エラーメッセージを隠す
      clearAnalysisCharts(); // 前のグラフをクリア

      const clinicReportData = issuedReports[currentClinicForModal];
      if (!clinicReportData) {
          console.error("No report data found for analysis.");
          showLoading(false);
          return;
      }

      let textList = [];
      let totalDocs = 0;
      // issuedReportsから分析対象のテキストリストを取得
      try {
        switch(columnType) {
            case 'L': // NPS理由
                textList = clinicReportData.npsData.rawText || []; // getReportDataで rawText を追加しておく
                totalDocs = clinicReportData.npsData.totalCount || 0;
                break;
            case 'I': // 良かった点
                textList = clinicReportData.feedbackData.i_column.results || [];
                totalDocs = clinicReportData.feedbackData.i_column.totalCount || 0;
                break;
            case 'J': // 印象スタッフ
                textList = clinicReportData.feedbackData.j_column.results || [];
                totalDocs = clinicReportData.feedbackData.j_column.totalCount || 0;
                break;
            case 'M': // お産意見
                textList = clinicReportData.feedbackData.m_column.results || [];
                totalDocs = clinicReportData.feedbackData.m_column.totalCount || 0;
                break;
            default:
                console.error("Invalid columnType for analysis:", columnType);
                showLoading(false);
                return;
        }
      } catch (e) {
         console.error("Error accessing text data for analysis:", e, "Data:", clinicReportData);
         alert("レポートデータへのアクセス中にエラーが発生しました。");
         showLoading(false);
         return;
      }


      document.getElementById('analysis-title').textContent = getAnalysisTitle(columnType, totalDocs);

      if (textList.length === 0) {
          console.log("No text data to analyze for:", columnType);
          document.getElementById('analysis-error').textContent = '分析対象のテキストデータがありません。';
          document.getElementById('analysis-error').classList.remove('hidden');
          showLoading(false);
          return;
      }

      try {
          console.log(`Sending ${textList.length} texts to /api/analyzeText`);
          const response = await fetch('/api/analyzeText', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ textList: textList })
          });

          if (!response.ok) {
              const errorText = await response.text();
              console.error(`Analyze API error (${response.status}):`, errorText);
              throw new Error(`分析APIエラー (${response.status}): ${errorText}`);
          }

          const analysisData = await response.json();
          console.log("Received analysis data:", analysisData);

          // グラフ描画
          drawAnalysisCharts(analysisData.results);

      } catch (error) {
          console.error('!!! Failed to analyze text:', error);
          document.getElementById('analysis-error').textContent = `テキスト分析に失敗しました: ${error.message}`;
          document.getElementById('analysis-error').classList.remove('hidden');
      } finally {
          showLoading(false);
      }
  }

  // 分析結果グラフ描画
  function drawAnalysisCharts(results) {
      if (!results || results.length === 0) {
          console.log("No analysis results to draw.");
          document.getElementById('analysis-error').textContent = '分析結果がありませんでした。';
          document.getElementById('analysis-error').classList.remove('hidden');
          return;
      }

      // 1. 品詞ごとにデータを分類
      const nouns = results.filter(r => r.pos === '名詞');
      const verbs = results.filter(r => r.pos === '動詞');
      const adjs = results.filter(r => r.pos === '形容詞');
      const ints = results.filter(r => r.pos === '感動詞');

      // 2. 棒グラフ描画 (Google Charts - Bar Chart)
      const barOptions = {
          // title: '出現頻度上位', // コンテナに表示するので不要
          bars: 'horizontal', // 横棒グラフ
          legend: { position: 'none' },
          hAxis: { title: 'スコア(出現頻度)', minValue: 0 },
          vAxis: { title: '単語' },
          // bar: { groupWidth: '80%' },
          height: 500, // ★ 各グラフの高さを固定 (コンテナでスクロール)
          width: '100%' // コンテナ幅に合わせる
          // ★ 色はコンテナのタイトルで表現
      };

      drawSingleBarChart(nouns.slice(0, 20), 'noun-chart', barOptions); // 上位20件表示
      drawSingleBarChart(verbs.slice(0, 20), 'verb-chart', barOptions);
      drawSingleBarChart(adjs.slice(0, 20), 'adj-chart', barOptions);
      drawSingleBarChart(ints.slice(0, 20), 'int-chart', barOptions);


      // 3. ワードクラウド描画 (WordCloud2.js)
      const wordCloudList = results.map(r => [
          r.word,
          r.score, // score (頻度) をサイズに反映
          r.pos // 品詞情報を色分け用に渡す (後で処理)
      ]).slice(0, 100); // ★ 上位100件をワードクラウド対象に

      const canvas = document.getElementById('word-cloud-canvas');
      if (WordCloud.isSupported && canvas) {
          WordCloud(canvas, {
              list: wordCloudList,
              gridSize: Math.round(16 * canvas.width / 1024),
              weightFactor: function (size) {
                  // スコアのスケール調整 (必要なら)
                  return Math.pow(size, 0.8) * canvas.width / 250;
              },
              fontFamily: 'Noto Sans JP, sans-serif',
              // ★ 品詞に応じて色を決定する関数
              color: function (word, weight, fontSize, distance, theta, data) {
                  const pos = data[2]; // listの3番目の要素 (品詞)
                  switch(pos) {
                      case '名詞': return '#3b82f6'; // 青系
                      case '動詞': return '#ef4444'; // 赤系
                      case '形容詞': return '#22c55e'; // 緑系
                      case '感動詞': return '#6b7280'; // グレー系
                      default: return '#a8a29e'; // その他 (念のため)
                  }
              },
              backgroundColor: '#f9fafb' // 背景色
          });
          console.log("Word cloud drawn.");
      } else {
          console.warn("WordCloud is not supported or canvas not found.");
          document.getElementById('word-cloud-container').innerHTML = '<p class="text-center text-gray-500">ワードクラウドを表示できません。</p>';
      }
  }

  // 単一の棒グラフを描画するヘルパー関数
  function drawSingleBarChart(data, elementId, options) {
      const container = document.getElementById(elementId);
      if (!container) return;

      if (!data || data.length === 0) {
          container.innerHTML = '<p class="text-center text-gray-500 text-sm py-4">データなし</p>';
          return;
      }

      // Google Charts用のデータ形式に変換 [単語, スコア]
      // 逆順にしてグラフの下から高スコアが表示されるようにする
      const chartData = [['単語', 'スコア']];
      data.reverse().forEach(item => {
          chartData.push([item.word, item.score]);
      });

      const dataTable = google.visualization.arrayToDataTable(chartData);
      const chart = new google.visualization.BarChart(container);
      chart.draw(dataTable, options);
  }

  // 分析画面のグラフをクリアする関数
  function clearAnalysisCharts() {
      document.getElementById('noun-chart').innerHTML = '';
      document.getElementById('verb-chart').innerHTML = '';
      document.getElementById('adj-chart').innerHTML = '';
      document.getElementById('int-chart').innerHTML = '';
      // ワードクラウドのCanvasもクリア (WordCloudライブラリが自動でクリアするかもしれないが念のため)
      const canvas = document.getElementById('word-cloud-canvas');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      document.getElementById('analysis-error').classList.add('hidden');
      document.getElementById('analysis-error').textContent = '';
  }

  // 列タイプから分析タイトルを取得
  function getAnalysisTitle(columnType, count) {
      const baseTitle = `アンケート結果　ー${getColumnName(columnType)}ー`;
      return `${baseTitle}　※全回答数${count}件ー`;
  }

  // 列タイプから列名を取得
  function getColumnName(columnType) {
      switch(columnType) {
          case 'L': return 'NPS推奨度 理由';
          case 'I': return '良かった点や悪かった点など';
          case 'J': return '印象に残ったスタッフへのコメント';
          case 'M': return 'お産にかかわるご意見・ご感想';
          default: return '不明';
      }
  }

  // 分析画面のナビゲーションのアクティブ表示を更新
  function updateAnalysisNavActiveState(activeType) {
      document.querySelectorAll('#analysis-nav .btn').forEach(btn => {
          if (btn.dataset.analysisType === activeType) {
              btn.classList.add('btn-active');
          } else {
              btn.classList.remove('btn-active');
          }
      });
  }


  // --- 汎用関数 (変更なし) ---
  function showScreen(screenId){ /* (変更なし) */ document.querySelectorAll('.screen').forEach(el=>el.classList.add('hidden'));document.getElementById(screenId).classList.remove('hidden'); }
  function showLoading(isLoading, message=''){ /* (変更なし) */ const o=document.getElementById('loading-overlay'),m=document.getElementById('loading-message');if(isLoading){m.textContent=message;o.classList.remove('hidden');}else{o.classList.add('hidden');m.textContent='';} }
  function showReportModal(show){ /* (変更なし) */ const m=document.getElementById('report-type-modal'),c=m.querySelector('div');if(show){m.classList.remove('hidden');setTimeout(()=>{c.classList.remove('scale-95','opacity-0');},10);}else{c.classList.add('scale-95','opacity-0');setTimeout(()=>{m.classList.add('hidden');},300);} }
  function updateNavActiveState(activeType){ /* (変更なし) */ document.querySelectorAll('#report-nav .btn').forEach(b=>{if(b.dataset.reportType===activeType){b.classList.add('btn-active');}else{b.classList.remove('btn-active');}}); }
  async function generatePdf(){ /* (変更なし - ダミーのまま) */ console.log('PDF export clicked.');alert('PDF生成機能はNode.jsサーバー側へ移植中です。');showLoading(true,'PDF生成中...');try{const r=await fetch('/generate-pdf');if(!r.ok){throw new Error(`サーバーエラー: ${r.statusText}`);} const b=await r.blob();const u=window.URL.createObjectURL(b);const a=document.createElement('a');a.style.display='none';a.href=u;a.download='report.pdf';document.body.appendChild(a);a.click();window.URL.revokeObjectURL(u);a.remove();showLoading(false);}catch(error){console.error('PDF gen error:',error);alert('PDF生成失敗\n'+error.message);showLoading(false);} }
</script>
</body>
</html>
